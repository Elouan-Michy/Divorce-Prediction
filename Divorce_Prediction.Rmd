---
title: "Divorce Prediction"
author: "Elouan-Joris"
date: "2025-09-30"
output:
  html_document:
    toc: true                # ‚úÖ active la table des mati√®res
    toc_float: true          # ‚úÖ menu d√©roulant flottant sur le c√¥t√©
    number_sections: true    # ‚úÖ num√©rotation des sections
    theme: cosmo             # üåà th√®me visuel (cosmo, united, journal, etc.)
    highlight: tango         # üé® style pour le code
    code_folding: show       # üîΩ possibilit√© de plier/d√©plier le code
    df_print: default
  
---


```{r setup, echo = FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```


```{r installing, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("dplyr")
```

```{r package, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)

```

# - Introduction

Le **mariage** est souvent per√ßu comme l'union d'une union durable, symbolisant l'engagement et la stabilit√© dans la vie d'un couple. Pourtant, dans de nombreux contextes, les mariages connaissent des trajectoires vari√©es : certains dure toute une vie, d'autre se terminent plus rapidement par un divorce. Ce ph√©nom√®ne est particuli√®rement int√©ressant √† observer lorsque celui-ci repose sur un mariage arrang√©, qui repose sur des dynamiques sociales et familiales diff√©rentes de celles d'un mariage romantique. Ces unions peuvent parfois r√©v√©ler des diff√©rences profondes entre les partenaires ou faire √©merger des sch√©mas de relations complexes, voire toxiques.

Dans le cadre de cette √©tude, nous utilisons une base de donn√©es synth√©tique portant sur des mariages arrang√©s afin d'examiner la dur√©e de ces unions et les facteurs susceptibles d'influencer leur stabilit√©s. **L'Analyse de Survie** constitue ici un outil pertinent pour mod√©liser le temps √©coul√© entre le mariage et le divorce afin de mieux comprendre la distribution temporelle des ruptures.





## - Presentation des variables

```{r 1 Chargement du fichier divorce_df.csv, echo = FALSE}
data.brute <- read.csv("divorce_df.csv")
dimension <- dim(data.brute)
n <- dimension[1]
p <- dimension[2]
```

Notre base de donn√©es comporte 5000 observations pour 22 variables. Sur les 22 variables, nous retrouvons pr√®s de 10 variables quantitatives pour 12 qualitatives. De plus, notre base de donn√©es ne comporte aucune valeurs manquantes, ce qui r√©duit la complexit√© des pr√©traitements des donn√©es et permet de d√©terminer directement l'analyse exploratoire. Le tableau ci-dessous synth√©tise la pr√©sentation ainsi que les types et sous-type de variables.

```{r echo = FALSE}

# Cr√©ation du dataframe

Nom_de_la_variable <- c("age_at_marriage","marriage_duration_years","divorced","num_children",
                         "education_level","employment_status","combined_income",
                         "religious_compatibility","cultural_background_match","communication_score",
                         "conflict_frequency","conflict_resolution_style","mental_health_issues",
                         "financial_stress_level","infidelity_occurred","counseling_attended",
                         "social_support","shared_hobbies_count","marriage_type",
                         "pre_marital_cohabitation","domestic_violence_history","trust_score")

Description <- c("√Çge au mariage","Dur√©e du mariage","Divorce (oui/non)","Nombre d‚Äôenfants",
                  "Niveau d‚Äô√©ducation","Statut professionnel","Revenu combin√©",
                  "Compatibilit√© religieuse","Correspondance culturelle","Score de communication",
                  "Fr√©quence des conflits","Style de r√©solution de conflit","Probl√®mes de sant√© mentale",
                  "Niveau de stress financier","Infid√©lit√© survenue","A suivi un counseling",
                  "Soutien social","Nombre de hobbies partag√©s","Type de mariage",
                  "Cohabitation avant mariage","Historique de violence domestique","Score de confiance")

Type <- c("Quantitative","Quantitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Qualitative","Qualitative","Quantitative",
           "Quantitative","Qualitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Quantitative","Qualitative","Qualitative",
           "Qualitative","Quantitative")

Sous_type = c("Discr√®te","Discr√®te","Binaire","Discr√®te","Ordinale",
                "Nominale","Continue","Nominale","Binaire","Continue",
                "Discr√®te","Nominale","Binaire","Continue","Binaire",
                "Binaire","Continue","Discr√®te","Nominale","Binaire",
                "Binaire","Continue")

variables <- data.frame(
  Nom_de_la_variable,
  Description,
  Type,
  Sous_type,
  stringsAsFactors = FALSE
)

# Fonction de coloration conditionnelle
variables <- variables %>%
  mutate(
    Type = cell_spec(Type,
                     background = ifelse(Type=="Quantitative","#5DADE2","#58D68D"),
                     color="black", bold=TRUE, escape=FALSE),
    Sous_type = cell_spec(Sous_type,
                          background = case_when(
                            Sous_type == "Binaire"   ~ "#A3E4D7",  # vert menthe
                            Sous_type == "Discr√®te"  ~ "#85C1E9",  # bleu clair
                            Sous_type == "Ordinale"  ~ "#F7DC6F",  # jaune dor√©
                            Sous_type == "Nominale"  ~ "#F5B041",  # orange doux
                            Sous_type == "Continue"  ~ "#E59866"   # rouge ros√©
                          ),
                          color = "black",
                          escape = FALSE)
  )

# Affichage du tableau
kable(variables, "html", escape=FALSE, caption="üìä Tableau des variables avec code couleur") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width=FALSE) %>%
  column_spec(1, bold=TRUE, color="black", background="#D6EAF8") %>%    # colonne Nom_de_la_variable
  column_spec(2, width="8cm", bold=TRUE, background="#EBF5FB") %>%       # colonne Description
  row_spec(0, bold=TRUE, color="white", background="#2C3E50")            # header
```

# - Analyse exploratoire

Dans cette section nous proc√©derons √† une grande...

## - Boxplot des donn√©es Quantitatives & Histogrammes




```{r 2 Boxplot Num√©rique, echo = FALSE, fig.align='center'}
# Prendre que les variables quantitatives
vars_quanti <- Nom_de_la_variable[Type == "Quantitative"]

for (i in 0:4) {
  # Grille 2 lignes √ó 5 colonnes
  par(mfrow = c(1, 2), mar = c(4, 4, 3, 1))
  for (j in 1:2) {
    var_name <- vars_quanti[2*i+j]
    boxplot(
      data.brute[[var_name]],
      main = var_name,
      col = "#5DADE2",
      boxwex = 0.5,
      outline = TRUE,
      cex.main = 0.9,
      cex.axis = 0.9,
      las = 1,
      frame.plot = FALSE
    )
    hist(
      data.brute[[var_name]],
      main = var_name,
      col = "#5DADE2",
      prob = TRUE,            # Pour afficher la densit√© et non la fr√©quence
      cex.main = 0.9,
      cex.axis = 0.9,
      las = 1,
      frame.plot = FALSE,
      border = "white"
    )
    grid(nx = NA, ny = NULL, col = "lightgray", lty = "dotted")
    lines(density(data.brute[[var_name]]), col = "red", lwd = 2)

    }
}
par(mfrow = c(1, 1))



```

## - Histogrammes des donn√©es Qualitatives

```{r 3 Barplot qualitative, echo = FALSE, fig.align='center'}
# S√©lection des variables qualitatives
vars_quali <- Nom_de_la_variable[Type == "Qualitative"]

# Grille 2 lignes √ó 5 colonnes
par(mfrow = c(2, 6), mar = c(6, 4, 3, 1)) 

for (i in 0:5) {
  # Grille 2 lignes √ó 5 colonnes
  par(mfrow = c(1, 2), mar = c(6, 4, 3, 1))
  for (j in 1:2) {
  var_name <- vars_quali[2*i+j]
  # Comptage des modalit√©s
  counts <- table(data.brute[[var_name]])
  
  # Titre avec retour √† la ligne si besoin
  main_title <- gsub("_", "\n", var_name)
  
  barplot(
    counts,
    main = main_title,
    col = "#58D68D",
    border = "gray25",
    cex.main = 0.9,
    cex.axis = 0.8,
    cex.names = 0.7,       # taille des noms des modalit√©s
    las = 2,               # rotation des labels pour qu‚Äôils soient lisibles
    frame.plot = FALSE
  )
  grid(nx = NA, ny = NULL, col = "lightgray", lty = "dotted")
  }
}


# ‚úÖ Revenir √† une seule figure
par(mfrow = c(1, 1))
```

# - Analyse de survie

Notre base de donn√©es comporte deux variables temporelles int√©ressantes √† √©tudier :

- `marriage_duration_years` : Mesure la **Dur√©e du mariage** de l'individu
- `age_at_marriage` : Mesure **l'√¢ge** o√π l'individu s'est mari√©

Nous verrons donc une double analyse entre sur la 

```{r tableaeu des fonctions de survies, echo = FALSE, fig.align='center'}
# Cr√©er le tableau

fonctions <- c("$S(t)$", "$H(t)$", "$h(t)$")
premier_temps <- c("Probabilit√© que le mariage dure ‚â• t",
                   "Risque cumul√© de divorce jusqu‚Äô√† t",
                   "Risque instantan√© de divorce √† t")
second_temps <- c("Probabilit√© de rester mari√© si mari√© √† l‚Äô√¢ge t",
                  "Risque cumul√© de divorce selon √¢ge au mariage ‚â§ t",
                  "Risque instantan√© de divorce pour un √¢ge de mariage t")

tableau <- data.frame(Fonction = fonctions,
                      marriage_duration_years = premier_temps,
                      age_at_marriage = second_temps,
                      stringsAsFactors = FALSE)

# Affichage avec kable
kable(tableau, "html", caption = "üìä Interpr√©tation des fonctions de survie") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE, background = "#D6EAF8") %>%
  column_spec(2, background = "#EBF5FB") %>%
  column_spec(3, background = "#FDEBD0") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")
```

## - Fonction de survie S(t)

**Estimateur de la fonction de survie sans donn√©es de censure :**

$$
\hat{S}(t) = \sum^{n}_{i = 1}1_{t_i>t}
$$

- n = le nombre total d'observation
- ti = temps jusqu'√† l'√©v√®nement pour l'individu i
- $1_{t_i>t}$ = Indicateur qui vaut 1 si l'individu n'a pas encore eu l'√©v√®nement √† t, 0 sinon.

**Pour introduire la censure, on d√©finit (ici le divorce) :**

$$
\delta_i =
\begin{cases}
1 & \text{si l'√©v√©nement observ√© pour i} \\
0 & \text{si censur√©}
\end{cases}
$$
On note $T_{1} \le T_{2} \le \dots \le T_{n}$ les temps tri√©s et $\delta_i$ les √©v√®nements correspondants.

Alors l'estimateur de Kaplan-Meier s'√©crit :

$$
\hat{S}(t) = \prod_{T_i \le t,\delta_i = 1}(1-\frac{1}{\sum^{n}_{j = 1}1_{T_j \ge T_i}})
$$

## - Analyse de la Dur√©e de marriage avant divorce 

**dur√©e de mariage**

```{r 4 Fonction de survie, echo = FALSE, fig.align='center'}
## Donn√©e NON CENSURE
variable_time <- data.brute$marriage_duration_years

# Donn√©es dur√©e de mariage
mar_dur <- variable_time

n_dim = length(mar_dur)
# Dur√©e 
t_values <- seq(1, max(mar_dur), by = 1)


S_estimate <- sapply(t_values, function(t) {
  sum(mar_dur > t) / n_dim
})

## Donn√©e CENSUR√â
time <- variable_time
divorce <- data.brute$divorced  # 1 = divorce, 0 = censur√©
# Trier par temps
sorted_idx <- order(time)
time_sorted <- time[sorted_idx]
divorce_sorted <- divorce[sorted_idx]
n <- length(time_sorted)
S <- numeric(n)       # stocke la survie √† chaque temps
surv_prob <- 1         # survie initiale = 1

for(i in 1:n){
  if(divorce_sorted[i] == 1){
    # nombre √† risque : tous les individus >= temps actuel
    n_risk <- sum(time_sorted >= time_sorted[i])
    # mise √† jour survie
    surv_prob <- surv_prob * (1 - 1 / n_risk)
  }
  S[i] <- surv_prob
}


# Plot initial vide avec limites
plot(NA, xlim = c(min(t_values), max(t_values)), ylim = c(0,1),
     xlab = "Dur√©e du mariage (ann√©es)",
     ylab = "S(t) = Probabilit√© de rester mari√©",
     main = "Comparaison fonction de survie")

# Ajouter l'escalier
lines(t_values, S_estimate, type = "s", col = "blue", lwd = 2)

lines(time_sorted, S, type = "s", col = "red", lwd = 2)

# L√©gende
legend("topright", legend = c("Sans censure", "Avec censure"),
       col = c("blue", "red"), lwd = 2)
```

**√¢ge du d√©but de mariage**
```{r 5 Fonction de survie, echo = FALSE, fig.align='center'}
## Donn√©e NON CENSURE
variable_time <- data.brute$age_at_marriage

# Donn√©es dur√©e de mariage
mar_dur <- variable_time

n_dim = length(mar_dur)
# Dur√©e 
t_values <- seq(min(mar_dur), max(mar_dur), by = 1)


S_estimate <- sapply(t_values, function(t) {
  sum(mar_dur > t) / n_dim
})

## Donn√©e CENSUR√â
time <- variable_time
divorce <- data.brute$divorced  # 1 = divorce, 0 = censur√©
# Trier par temps
sorted_idx <- order(time)
time_sorted <- time[sorted_idx]
divorce_sorted <- divorce[sorted_idx]
n <- length(time_sorted)
S <- numeric(n)       # stocke la survie √† chaque temps
surv_prob <- 1         # survie initiale = 1

for(i in 1:n){
  if(divorce_sorted[i] == 1){
    # nombre √† risque : tous les individus >= temps actuel
    n_risk <- sum(time_sorted >= time_sorted[i])
    # mise √† jour survie
    surv_prob <- surv_prob * (1 - 1 / n_risk)
  }
  S[i] <- surv_prob
}


# Plot initial vide avec limites
plot(NA, xlim = c(min(t_values), max(t_values)), ylim = c(0,1),
     xlab = "Dur√©e du mariage (ann√©es)",
     ylab = "S(t) = Probabilit√© de rester mari√©",
     main = "Comparaison fonction de survie")

# Ajouter l'escalier
lines(t_values, S_estimate, type = "s", col = "blue", lwd = 2)

lines(time_sorted, S, type = "s", col = "red", lwd = 2)

# L√©gende
legend("topright", legend = c("Sans censure", "Avec censure"),
       col = c("blue", "red"), lwd = 2)
```


```{r 6 Fonction de Risque Cumul√©e, echo = FALSE, fig.align='center'}
# Plot initial vide avec limites
plot(NA, xlim = c(1, max(t_values)), ylim = c(0,5),
     xlab = "Dur√©e du mariage (ann√©es)",
     ylab = "H(t) = Risque cumul√©e",
     main = "Comparaison fonction de risque cumul√©")

H_estimate = -log(S_estimate)
H = -log(S)

# Ajouter l'escalier
lines(t_values, H_estimate, type = "s", col = "blue", lwd = 2)

lines(time_sorted, H, type = "s", col = "red", lwd = 2)

# L√©gende
legend("topleft", legend = c("Sans censure", "Avec censure"),
       col = c("blue", "red"), lwd = 2)

```

```{r 7 Fonction de risque instantan√©e, echo = FALSE, fig.align='center'}
library(survival)

surv_obj <- Surv(time = data.brute$marriage_duration_years,
                 event = data.brute$divorced)
cox_model <- coxph(surv_obj ~ 1, data = data.brute)


fit <- survfit(cox_model)

# temps
time <- fit$time
# survie
S <- fit$surv

# hazard approximatif √† chaque intervalle
hazard <- -diff(S) / S[-length(S)]

# associer aux temps moyens des intervalles
time_hazard <- time[-1]

# tracer
plot(time_hazard, hazard, type = "s",
     xlab = "Dur√©e du mariage (ann√©es)",
     ylab = "Risque instantan√©",
     main = "Fonction de risque estim√©e √† partir de Cox",
     lwd = 2, col = "red")
grid()

smooth_h <- smooth.spline(time_hazard, hazard)
plot(smooth_h, type="l", lwd=2, col="blue",
     xlab="Dur√©e du mariage (ann√©es)",
     ylab="Risque instantan√©",
     main="Fonction de risque liss√©e √† partir de Cox")
grid()

```

## - Analyse de la Dur√©e de rester mari√© avant le disvorce √† l'√¢ge t
test git 
