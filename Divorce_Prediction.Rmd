---
title: "Divorce Prediction"
author: "Elouan-Joris"
date: "2025-09-30"
output:
  html_document:
    toc: true                # ‚úÖ active la table des mati√®res
    toc_float: true          # ‚úÖ menu d√©roulant flottant sur le c√¥t√©
    number_sections: true    # ‚úÖ num√©rotation des sections
    theme: cosmo             # üåà th√®me visuel (cosmo, united, journal, etc.)
    highlight: tango         # üé® style pour le code
    code_folding: show       # üîΩ possibilit√© de plier/d√©plier le code
    df_print: default
  
---

lien de la base : https://www.kaggle.com/datasets/vanpatangan/divorce-prediction


```{r setup, echo = FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```


```{r installing, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("dplyr")
#install.packages("survival")
#install.packages("survminer")
```

```{r package, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(knitr)
library(kableExtra)
library(dplyr)
library(survival)
library(survminer)
library(gridExtra)
library(ggplot2)
```

# - Introduction

Le **mariage** est souvent per√ßu comme l'union d'une union durable, symbolisant l'engagement et la stabilit√© dans la vie d'un couple. Pourtant, dans de nombreux contextes, les mariages connaissent des trajectoires vari√©es : certains dure toute une vie, d'autre se terminent plus rapidement par un divorce. Ce ph√©nom√®ne est particuli√®rement int√©ressant √† observer lorsque celui-ci repose sur un mariage arrang√©, qui repose sur des dynamiques sociales et familiales diff√©rentes de celles d'un mariage romantique. Ces unions peuvent parfois r√©v√©ler des diff√©rences profondes entre les partenaires ou faire √©merger des sch√©mas de relations complexes, voire toxiques.

Dans le cadre de cette √©tude, nous utilisons une base de donn√©es synth√©tique portant sur des mariages arrang√©s afin d'examiner la dur√©e de ces unions et les facteurs susceptibles d'influencer leur stabilit√©s. **L'Analyse de Survie** constitue ici un outil pertinent pour mod√©liser le temps √©coul√© entre le mariage et le divorce afin de mieux comprendre la distribution temporelle des ruptures.





## - Presentation des variables

```{r 1 Chargement du fichier divorce_df.csv, echo = FALSE}
data.brute <- read.csv("divorce_df.csv")
dimension <- dim(data.brute)
n <- dimension[1]
p <- dimension[2]
```

Notre base de donn√©es comporte 5000 observations pour 22 variables. Sur les 22 variables, nous retrouvons pr√®s de 10 variables quantitatives pour 12 qualitatives. De plus, notre base de donn√©es ne comporte aucune valeurs manquantes, ce qui r√©duit la complexit√© des pr√©traitements des donn√©es et permet de d√©terminer directement l'analyse exploratoire. Le tableau ci-dessous synth√©tise la pr√©sentation ainsi que les types et sous-type de variables.

```{r echo = FALSE}

# Cr√©ation du dataframe

Nom_de_la_variable <- c("age_at_marriage","marriage_duration_years","divorced","num_children",
                         "education_level","employment_status","combined_income",
                         "religious_compatibility","cultural_background_match","communication_score",
                         "conflict_frequency","conflict_resolution_style","mental_health_issues",
                         "financial_stress_level","infidelity_occurred","counseling_attended",
                         "social_support","shared_hobbies_count","marriage_type",
                         "pre_marital_cohabitation","domestic_violence_history","trust_score")

Description <- c("√Çge au mariage","Dur√©e du mariage","Divorce (oui/non)","Nombre d‚Äôenfants",
                  "Niveau d‚Äô√©ducation","Statut professionnel","Revenu combin√©",
                  "Compatibilit√© religieuse","Correspondance culturelle","Score de communication",
                  "Fr√©quence des conflits","Style de r√©solution de conflit","Probl√®mes de sant√© mentale",
                  "Niveau de stress financier","Infid√©lit√© survenue","A suivi un counseling",
                  "Soutien social","Nombre de hobbies partag√©s","Type de mariage",
                  "Cohabitation avant mariage","Historique de violence domestique","Score de confiance")

Type <- c("Quantitative","Quantitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Qualitative","Qualitative","Quantitative",
           "Quantitative","Qualitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Quantitative","Qualitative","Qualitative",
           "Qualitative","Quantitative")

Sous_type = c("Discr√®te","Discr√®te","Binaire","Discr√®te","Ordinale",
                "Nominale","Continue","Nominale","Binaire","Continue",
                "Discr√®te","Nominale","Binaire","Continue","Binaire",
                "Binaire","Continue","Discr√®te","Nominale","Binaire",
                "Binaire","Continue")

variables <- data.frame(
  Nom_de_la_variable,
  Description,
  Type,
  Sous_type,
  stringsAsFactors = FALSE
)

# Fonction de coloration conditionnelle
variables <- variables %>%
  mutate(
    Type = cell_spec(Type,
                     background = ifelse(Type=="Quantitative","#5DADE2","#58D68D"),
                     color="black", bold=TRUE, escape=FALSE),
    Sous_type = cell_spec(Sous_type,
                          background = case_when(
                            Sous_type == "Binaire"   ~ "#A3E4D7",  # vert menthe
                            Sous_type == "Discr√®te"  ~ "#85C1E9",  # bleu clair
                            Sous_type == "Ordinale"  ~ "#F7DC6F",  # jaune dor√©
                            Sous_type == "Nominale"  ~ "#F5B041",  # orange doux
                            Sous_type == "Continue"  ~ "#E59866"   # rouge ros√©
                          ),
                          color = "black",
                          escape = FALSE)
  )

# Affichage du tableau
kable(variables, "html", escape=FALSE, caption="üìä Tableau des variables avec code couleur") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width=FALSE) %>%
  column_spec(1, bold=TRUE, color="black", background="#D6EAF8") %>%    # colonne Nom_de_la_variable
  column_spec(2, width="8cm", bold=TRUE, background="#EBF5FB") %>%       # colonne Description
  row_spec(0, bold=TRUE, color="white", background="#2C3E50")            # header
```

# - Analyse exploratoire


## - Boxplot des donn√©es Quantitatives & Histogrammes




```{r 2 Boxplot Num√©rique, echo = FALSE, fig.align='center'}
# Prendre que les variables quantitatives
vars_quanti <- Nom_de_la_variable[Type == "Quantitative"]

for (i in 0:4) {
  # Grille 2 lignes √ó 5 colonnes
  par(mfrow = c(1, 2), mar = c(4, 4, 3, 1))
  for (j in 1:2) {
    var_name <- vars_quanti[2*i+j]
    boxplot(
      data.brute[[var_name]],
      main = var_name,
      col = "#5DADE2",
      boxwex = 0.5,
      outline = TRUE,
      cex.main = 0.9,
      cex.axis = 0.9,
      las = 1,
      frame.plot = FALSE
    )
    hist(
      data.brute[[var_name]],
      main = var_name,
      col = "#5DADE2",
      prob = TRUE,            # Pour afficher la densit√© et non la fr√©quence
      cex.main = 0.9,
      cex.axis = 0.9,
      las = 1,
      frame.plot = FALSE,
      border = "white"
    )
    grid(nx = NA, ny = NULL, col = "lightgray", lty = "dotted")
    lines(density(data.brute[[var_name]]), col = "red", lwd = 2)

    }
}
par(mfrow = c(1, 1))



```

## - Histogrammes des donn√©es Qualitatives

```{r 3 Barplot qualitative, echo = FALSE, fig.align='center'}
# S√©lection des variables qualitatives
vars_quali <- Nom_de_la_variable[Type == "Qualitative"]

# Grille 2 lignes √ó 5 colonnes
par(mfrow = c(2, 6), mar = c(6, 4, 3, 1)) 

for (i in 0:5) {
  # Grille 2 lignes √ó 5 colonnes
  par(mfrow = c(1, 2), mar = c(6, 4, 3, 1))
  for (j in 1:2) {
  var_name <- vars_quali[2*i+j]
  # Comptage des modalit√©s
  counts <- table(data.brute[[var_name]])
  
  # Titre avec retour √† la ligne si besoin
  main_title <- gsub("_", "\n", var_name)
  
  barplot(
    counts,
    main = main_title,
    col = "#58D68D",
    border = "gray25",
    cex.main = 0.9,
    cex.axis = 0.8,
    cex.names = 0.7,       # taille des noms des modalit√©s
    las = 2,               # rotation des labels pour qu‚Äôils soient lisibles
    frame.plot = FALSE
  )
  grid(nx = NA, ny = NULL, col = "lightgray", lty = "dotted")
  }
}


# ‚úÖ Revenir √† une seule figure
par(mfrow = c(1, 1))
```

# - Analyse de survie

Notre base de donn√©es comporte deux variables temporelles int√©ressantes √† √©tudier :

- `marriage_duration_years` : Mesure la **Dur√©e du mariage** de l'individu
- `age_at_marriage` : Mesure **l'√¢ge** o√π l'individu s'est mari√©

Nous verrons donc une double analyse entre sur la 

```{r tableaeu des fonctions de survies, echo = FALSE, fig.align='center'}


# D√©finition des colonnes
fonctions <- c("$S(t)$", "$H(t)$", "$h(t)$")

definitions <- c(
  "$S(t) = P(T \\geq t)$",
  "$H(t) = \\int_0^t h(u)\\,du = -\\ln S(t)$",
  "$h(t) = \\dfrac{f(t)}{S(t)} = -\\dfrac{S'(t)}{S(t)}$"
)

premier_temps <- c(
  "Probabilit√© que le mariage dure ‚â• t",
  "Risque cumul√© de divorce jusqu‚Äô√† t",
  "Risque instantan√© de divorce √† t"
)

second_temps <- c(
  "Probabilit√© de rester mari√© si mari√© √† l‚Äô√¢ge t",
  "Risque cumul√© de divorce selon √¢ge au mariage ‚â§ t",
  "Risque instantan√© de divorce pour un √¢ge de mariage t"
)

# Cr√©ation du tableau
tableau <- data.frame(
  Fonction = fonctions,
  D√©finition = definitions,
  Dur√©e_du_mariage = premier_temps,
  √Çge_au_mariage = second_temps,
  stringsAsFactors = FALSE
)

# Affichage avec kable
kable(tableau, "html", caption = "üìä Interpr√©tation et d√©finitions des fonctions de survie") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, bold = TRUE, background = "#D6EAF8") %>%
  column_spec(2, background = "#EBF5FB") %>%
  column_spec(3, background = "#FDEBD0") %>%
  column_spec(4, background = "#FCF3CF") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")

```

## - Fonction de survie S(t)

### Estimateur sans donn√©es de censure

**Estimateur empirique de la fonction de survie :**

$$
\hat{S}(t) = \frac{1}{n} \sum_{i = 1}^{n} 1_{t_i > t}
$$

- \( n \) = nombre total d'observations  
- \( t_i \) = temps jusqu‚Äô√† l‚Äô√©v√©nement pour l‚Äôindividu \( i \)  
- \( 1_{t_i > t} \) = indicateur qui vaut 1 si l‚Äôindividu n‚Äôa pas encore eu l‚Äô√©v√©nement √† \( t \), 0 sinon  

Cet estimateur correspond simplement √† la **proportion d‚Äôindividus encore ‚Äúen vie‚Äù** (ou mari√©s) au temps \( t \).  
Il suppose qu‚Äôil **n‚Äôy a aucune donn√©e censur√©e**, c‚Äôest-√†-dire que tous les individus ont eu l‚Äô√©v√©nement observ√©.

---

### Estimateur avec censure (Kaplan-Meier)

Lorsque certains individus quittent l‚Äô√©tude avant l‚Äô√©v√©nement (par exemple, encore mari√©s √† la fin de l‚Äôobservation),  
on introduit la **variable de censure** :

$$
\delta_i =
\begin{cases}
1 & \text{si l'√©v√©nement (divorce) est observ√© pour } i \\
0 & \text{si l'observation est censur√©e}
\end{cases}
$$

On note \( T_{1} \le T_{2} \le \dots \le T_{n} \) les temps d‚Äôobservation tri√©s et \( \delta_i \) les √©v√©nements correspondants.

**Alors, l‚Äôestimateur de Kaplan-Meier s‚Äô√©crit :**

$$
\hat{S}(t) = \prod_{T_i \le t,\, \delta_i = 1} 
\left( 1 - \frac{1}{\sum_{j = 1}^{n} 1_{T_j \ge T_i}} \right)
$$

ou, de mani√®re √©quivalente, en notant \( d_i \) le nombre d‚Äô√©v√©nements √† \( T_i \)  
et \( n_i \) le nombre d‚Äôindividus ‚Äú√† risque‚Äù juste avant ce temps :

$$
\hat{S}(t) = \prod_{T_i \le t} 
\left( 1 - \frac{d_i}{n_i} \right)
$$

---

## - Analyse de la Dur√©e de marriage avant divorce 

**dur√©e de mariage**

```{r 4 Fonction de survie, echo = FALSE, fig.align='center'}
# --- Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- 1Ô∏è‚É£ SANS CENSURE
surv_no_censor <- survfit(Surv(time, rep(1,length(time))) ~ 1)

# --- 2Ô∏è‚É£ AVEC CENSURE
surv_censor <- survfit(Surv(time, event) ~ 1)

# --- 3Ô∏è‚É£ PLOT COMPARATIF avec intervalle de confiance
ggsurvplot_combine(
  list("Sans censure" = surv_no_censor, "Avec censure" = surv_censor),
  combine = TRUE,
  conf.int = TRUE,                     # activer l'intervalle de confiance
  conf.int.alpha = 0.2,                # transparence de la bande
  legend.title = "Type de donn√©es",
  legend.labs = c("Sans censure", "Avec censure"),
  palette = c("blue", "red"),
  xlab = "Dur√©e du mariage (ann√©es)",
  ylab = "S(t) = Probabilit√© de rester mari√©",
  title = "Comparaison des fonctions de survie : sans et avec censure"
)
```

```{r 6.1, echo = FALSE, fig.align='center'}
# Cr√©ation du tableau
risk_methods <- data.frame(
  M√©thode = c("Kaplan-Meier simple", "Nelson-Aalen", "Cox avec covariables (Breslow)"),
  Formule = c(
    "$H(t) = -\\ln \\hat{S}(t)$",
    "$\\hat{H}_{NA}(t) = \\sum_{t_i \\le t} \\dfrac{d_i}{n_i}$",
    "$\\hat{H}_{Breslow}(t) = \\sum_{t_i \\le t} \\dfrac{d_i}{\\sum_{j \\in R(t_i)} e^{\\beta^T X_j}}$"
  ),
  Description = c(
    "Transformation directe de la fonction de survie Kaplan-Meier. Non param√©trique et simple.",
    "Estimateur non param√©trique bas√© sur les √©v√©nements observ√©s et le nombre de sujets √† risque.",
    "Risque cumulatif estim√© √† partir d‚Äôun mod√®le de Cox avec covariables. Breslow g√®re les √©v√©nements multiples au m√™me temps."
  ),
  stringsAsFactors = FALSE
)

# Affichage avec kable et style
kable(risk_methods, "html", escape = FALSE, caption = "üìä M√©thodes d‚Äôestimation du risque cumulatif") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black", background = "#D6EAF8") %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "8cm") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")
```

```{r 6 Fonction de Risque Cumul√©e, echo = FALSE, fig.align='center'}
# --- Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- 1Ô∏è‚É£ Kaplan-Meier
km_fit <- survfit(Surv(time, event) ~ 1)
df_km <- data.frame(
  time = km_fit$time,
  H = -log(km_fit$surv)
)

# --- 2Ô∏è‚É£ Nelson-Aalen
# H(t) = sum(d_i / n_i)
na_fit <- survfit(Surv(time, event) ~ 1, type="fleming")  # Fleming-Harrington = Nelson-Aalen
df_na <- data.frame(
  time = na_fit$time,
  H = na_fit$cumhaz
)

# --- Fusionner pour ggplot
df_all <- bind_rows(
  df_km %>% mutate(Method = "Kaplan-Meier"),
  df_na %>% mutate(Method = "Nelson-Aalen")
)

# --- Plot
ggplot(df_all, aes(x = time, y = H, color = Method)) +
  geom_step(size = 1.2) +
  scale_color_manual(values = c("blue","red")) +
  labs(
    title = "Comparaison des fonctions de risque cumul√©e",
    x = "Dur√©e du mariage (ann√©es)",
    y = "H(t) = Risque cumulatif",
    color = "M√©thode"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "top"
  )

```



```{r 7 Fonction de risque instantan√©e, echo = FALSE, fig.align='center'}

# --- Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- Hazard avec censure
fit_censor <- survfit(Surv(time, event) ~ 1)
H_censor <- -log(fit_censor$surv)
time_censor <- fit_censor$time[-1]
hazard_censor <- diff(H_censor) / diff(fit_censor$time)

# --- Hazard sans censure
fit_no_censor <- survfit(Surv(time, rep(1,length(time))) ~ 1)
H_no_censor <- -log(fit_no_censor$surv)
time_no_censor <- fit_no_censor$time[-1]
hazard_no_censor <- diff(H_no_censor) / diff(fit_no_censor$time)

# --- Pr√©parer data.frame pour ggplot
df_hazard <- rbind(
  data.frame(time = time_censor, hazard = hazard_censor, type = "Avec censure"),
  data.frame(time = time_no_censor, hazard = hazard_no_censor, type = "Sans censure")
)

# --- Plot ggplot2 escalier (step)
ggplot(df_hazard, aes(x = time, y = hazard, color = type)) +
  geom_step(size = 1.5) +                           # courbes en escalier
  scale_color_manual(values = c("red","blue")) +   # couleurs coh√©rentes
  labs(title = "Fonction de risque instantan√©e",
       x = "Dur√©e du mariage (ann√©es)",
       y = "Risque instantan√©",
       color = "Type de donn√©es") +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "top")
```




## - Analyse de la Dur√©e de rester mari√© avant le disvorce √† l'√¢ge t

