
```{r source data_prepared, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
suppressPackageStartupMessages(source("setup.R"))
```

# Description et pr√©paration des donn√©es

## - Presentation des variables

```{r data_prepared_0, echo = FALSE}
dimension <- dim(data.brute)
n <- dimension[1]
p <- dimension[2]
```

Notre base de donn√©es comporte 5000 observations pour 22 variables. Sur les 22 variables, nous retrouvons pr√®s de 10 variables quantitatives pour 12 qualitatives. De plus, notre base de donn√©es ne comporte aucune valeurs manquantes, ce qui r√©duit la complexit√© des pr√©traitements des donn√©es et permet de d√©terminer directement l'analyse exploratoire. Le tableau ci-dessous synth√©tise la pr√©sentation ainsi que les types et sous-type de variables.

```{r data_prepared_1, echo = FALSE}

# Cr√©ation du dataframe

Nom_de_la_variable <- c("age_at_marriage","marriage_duration_years","divorced","num_children",
                         "education_level","employment_status","combined_income",
                         "religious_compatibility","cultural_background_match","communication_score",
                         "conflict_frequency","conflict_resolution_style","mental_health_issues",
                         "financial_stress_level","infidelity_occurred","counseling_attended",
                         "social_support","shared_hobbies_count","marriage_type",
                         "pre_marital_cohabitation","domestic_violence_history","trust_score")

Description <- c("√Çge au mariage","Dur√©e du mariage","Divorce (oui/non)","Nombre d‚Äôenfants",
                  "Niveau d‚Äô√©ducation","Statut professionnel","Revenu combin√©",
                  "Compatibilit√© religieuse","Correspondance culturelle","Score de communication",
                  "Fr√©quence des conflits","Style de r√©solution de conflit","Probl√®mes de sant√© mentale",
                  "Niveau de stress financier","Infid√©lit√© survenue","A suivi un counseling",
                  "Soutien social","Nombre de hobbies partag√©s","Type de mariage",
                  "Cohabitation avant mariage","Historique de violence domestique","Score de confiance")

Type <- c("Quantitative","Quantitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Qualitative","Qualitative","Quantitative",
           "Quantitative","Qualitative","Qualitative","Quantitative","Qualitative",
           "Qualitative","Quantitative","Quantitative","Qualitative","Qualitative",
           "Qualitative","Quantitative")

Sous_type = c("Discr√®te","Discr√®te","Binaire","Discr√®te","Ordinale",
                "Nominale","Continue","Nominale","Binaire","Continue",
                "Discr√®te","Nominale","Binaire","Continue","Binaire",
                "Binaire","Continue","Discr√®te","Nominale","Binaire",
                "Binaire","Continue")

variables <- data.frame(
  Nom_de_la_variable,
  Description,
  Type,
  Sous_type,
  stringsAsFactors = FALSE
)

# Fonction de coloration conditionnelle
variables <- variables %>%
  mutate(
    Type = cell_spec(Type,
                     background = ifelse(Type=="Quantitative","#5DADE2","#58D68D"),
                     color="black", bold=TRUE, escape=FALSE),
    Sous_type = cell_spec(Sous_type,
                          background = case_when(
                            Sous_type == "Binaire"   ~ "#A3E4D7",  # vert menthe
                            Sous_type == "Discr√®te"  ~ "#85C1E9",  # bleu clair
                            Sous_type == "Ordinale"  ~ "#F7DC6F",  # jaune dor√©
                            Sous_type == "Nominale"  ~ "#F5B041",  # orange doux
                            Sous_type == "Continue"  ~ "#E59866"   # rouge ros√©
                          ),
                          color = "black",
                          escape = FALSE)
  )

# Affichage du tableau
kable(variables, "html", escape=FALSE, caption="üìä Tableau des variables avec code couleur") %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width=FALSE) %>%
  column_spec(1, bold=TRUE, color="black", background="#D6EAF8") %>%    # colonne Nom_de_la_variable
  column_spec(2, width="8cm", bold=TRUE, background="#EBF5FB") %>%       # colonne Description
  row_spec(0, bold=TRUE, color="white", background="#2C3E50")            # header
```



## - Boxplot des donn√©es Quantitatives & Histogrammes

```{r data_prepared_2, echo = FALSE}
library(plotly)
library(RColorBrewer)

vars_quanti <- Nom_de_la_variable[Type == "Quantitative"]
n <- length(vars_quanti)

# Palette
cols <- brewer.pal(max(n, 3), "Set2")
if (length(cols) < n) cols <- colorRampPalette(cols)(n)

fig <- plot_ly()

for (i in seq_along(vars_quanti)) {

  x <- data.brute[[vars_quanti[i]]]

  # Histogramme
  fig <- fig %>% add_histogram(
    x = x,
    visible = (i == 1),
    xaxis = "x1",
    yaxis = "y1",
    marker = list(color = cols[i]),
    opacity = 0.7,
    showlegend = FALSE
  )

  # Boxplot
  fig <- fig %>% add_boxplot(
    y = x,
    visible = (i == 1),
    xaxis = "x2",
    yaxis = "y2",
    fillcolor = cols[i],
    line = list(color = cols[i]),
    marker = list(color = cols[i]),
    opacity = 0.7,
    boxpoints = "outliers",
    showlegend = FALSE,
    name = ""  # <-- force le nom vide
  )

}

# ---- Dropdown menu ----
buttons <- lapply(seq_len(n), function(i) {

  vis <- rep(FALSE, 2 * n)
  vis[(2*i - 1):(2*i)] <- TRUE

  list(
    method = "update",
    args = list(
      list(visible = vis)
      ),
    label = vars_quanti[i]
  )
})

fig <- fig %>% layout(
  updatemenus = list(
    list(
      type = "dropdown",
      active = 0,
      buttons = buttons,
      x = 0.5,
      y = 1.15,
      xanchor = "center"
    )
  ),
  grid = list(rows = 1, columns = 2, pattern = "independent"),
  xaxis = list(title = "Valeurs"),
  yaxis = list(title = "Effectifs"),
  xaxis2 = list(title = ""),
  yaxis2 = list(title = "Valeurs"),
  width = 700,
  height = 400,
  showlegend = FALSE
)

fig



```

L‚Äôanalyse de la variable `marriage_duration_years` montre une distribution d√©croissante, avec la majorit√© des mariages ayant une dur√©e relativement courte. Les effectifs diminuent progressivement lorsque la dur√©e augmente. La dur√©e minimale observ√©e est de 1 ans, la maximale de 40 ans, et la m√©diane est de 6 ans. On remarque √©galement quelques valeurs extr√™mes entre 30 et 40 ans, qui sont isol√©es par rapport √† la majorit√© des observations. Ces outliers peuvent refl√©ter des cas particuliers de mariages tr√®s longs.

## - Histogrammes des donn√©es Qualitatives

```{r data_prepared_3, echo = FALSE, fig.align='center'}
library(plotly)
library(RColorBrewer)

# S√©lection des variables qualitatives
vars_quali <- Nom_de_la_variable[Type == "Qualitative"]
n <- length(vars_quali)

fig <- plot_ly()

for (i in seq_along(vars_quali)) {

  var <- vars_quali[i]
  counts <- table(data.brute[[var]])

  df <- data.frame(
    modalite = names(counts),
    n = as.numeric(counts)
  )

  df$pct <- round(100 * df$n / sum(df$n), 1)

  # Palette pour les modalit√©s
  cols <- brewer.pal(max(3, nrow(df)), "Set2")
  if (length(cols) < nrow(df)) {
    cols <- colorRampPalette(cols)(nrow(df))
  }

  ## ---- Pie chart ----
  fig <- fig %>% add_pie(
    data = df,
    labels = ~modalite,
    values = ~n,
    visible = (i == 1),
    textinfo = "label+percent",
    marker = list(colors = cols),
    showlegend = FALSE
  )
}

## ---- Dropdown menu ----
buttons <- lapply(seq_len(n), function(i) {

  vis <- rep(FALSE, n)
  vis[i] <- TRUE

  list(
    method = "update",
    args = list(
      list(visible = vis)
    ),
    label = vars_quali[i]
  )
})

## ---- Layout final ----
fig <- fig %>% layout(
  updatemenus = list(
    list(
      type = "dropdown",
      active = 0,
      buttons = buttons,
      x = 0.5,
      y = 1.15,
      xanchor = "center"
    )
  ),
  width = 700,
  height = 500,
  showlegend = FALSE
)

fig


```
