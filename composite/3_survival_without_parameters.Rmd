
```{r source survival_without_parameters, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
suppressPackageStartupMessages(source("setup.R"))
```

# - Analyse de survie

Notre base de donn√©es comporte deux variables temporelles int√©ressantes √† √©tudier :

- `marriage_duration_years` : Mesure la **Dur√©e du mariage** de l'individu
- `age_at_marriage` : Mesure **l'√¢ge** o√π l'individu s'est mari√©

Nous verrons donc une double analyse entre sur la 

```{r survival_without_parameters_0, echo = FALSE, fig.align='center'}


# D√©finition des colonnes
fonctions <- c("$S(t)$", "$H(t)$", "$h(t)$")

definitions <- c(
  "$S(t) = P(T \\geq t) = e^{-H(t)}$",
  "$H(t) = \\int_0^t h(u)\\,du = -\\ln S(t)$",
  "$h(t) = -\\dfrac{S'(t)}{S(t)}$"
)

premier_temps <- c(
  "Probabilit√© que le mariage dure ‚â• t",
  "Risque cumul√© de divorce jusqu‚Äô√† t",
  "Risque instantan√© de divorce √† t"
)

second_temps <- c(
  "Probabilit√© de rester mari√© si mari√© √† l‚Äô√¢ge t",
  "Risque cumul√© de divorce selon √¢ge au mariage ‚â§ t",
  "Risque instantan√© de divorce pour un √¢ge de mariage t"
)

# Cr√©ation du tableau
tableau <- data.frame(
  Fonction = fonctions,
  D√©finition = definitions,
  Dur√©e_du_mariage = premier_temps,
  √Çge_au_mariage = second_temps,
  stringsAsFactors = FALSE
)

# Affichage avec kable
kable(tableau, "html", caption = "üìä Interpr√©tation et d√©finitions des fonctions de survie", align = c("c","c","c","c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, bold = TRUE, background = "#D6EAF8") %>%
  column_spec(2, background = "#EBF5FB") %>%
  column_spec(3, background = "#FDEBD0") %>%
  column_spec(4, background = "#FCF3CF") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")

```

## - Fonction de survie S(t)

### Estimateur sans donn√©es de censure

**Estimateur empirique de la fonction de survie :**

$$
\hat{S}(t) = \frac{1}{n} \sum_{i=1}^{n} \boldsymbol{1}_{\{t_i > t\}}
$$

- \( n \) = nombre total d'observations  
- \( t_i \) = temps jusqu‚Äô√† l‚Äô√©v√©nement pour l‚Äôindividu \( i \)  
- \( \boldsymbol{1}_{\{t_i > t\}} \) = indicateur qui vaut 1 si l‚Äôindividu n‚Äôa pas encore eu l‚Äô√©v√©nement √† \( t \), 0 sinon  

Cet estimateur correspond simplement √† la **proportion d‚Äôindividus encore mari√©s au temps \( t \).  
Il suppose qu‚Äôil **n‚Äôy a aucune donn√©e censur√©e**, c‚Äôest-√†-dire que tous les individus ont eu l‚Äô√©v√©nement observ√©.

---

### Estimateur avec censure (Kaplan-Meier)

Lorsque certains individus quittent l‚Äô√©tude avant l‚Äô√©v√©nement (par exemple, encore mari√©s √† la fin de l‚Äôobservation),  
on introduit la **variable de censure** :

$$
\delta_i =
\begin{cases}
1 & \text{si l'√©v√©nement (divorce) est observ√© pour } i \\
0 & \text{si l'observation est censur√©e}
\end{cases}
$$

On note \( T_{1} \le T_{2} \le \dots \le T_{n} \) les temps d‚Äôobservation tri√©s et \( \delta_i \) les √©v√©nements correspondants.

**Alors, l‚Äôestimateur de Kaplan-Meier s‚Äô√©crit :**

$$
\hat{S}(t) = \prod_{T_i \le t,\, \delta_i = 1} 
\left( 1 - \frac{1}{\sum_{j = 1}^{n} 1_{T_j \ge T_i}} \right)
$$

ou, de mani√®re √©quivalente, en notant \( d_i \) le nombre d‚Äô√©v√©nements √† \( T_i \)  
et \( n_i \) le nombre d‚Äôindividus ‚Äú√† risque‚Äù juste avant ce temps :

$$
\hat{S}(t) = \prod_{T_i \le t} 
\left( 1 - \frac{d_i}{n_i} \right)
$$

---

## - Fonction de survie : Kaplan-Meier

```{r survival_without_parameters_1, echo = FALSE, fig.align='center'}
# --- Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- 1Ô∏è‚É£ SANS CENSURE
surv_no_censor <- survfit(Surv(time, rep(1,length(time))) ~ 1)
# summary(surv_no_censor)

# --- 2Ô∏è‚É£ AVEC CENSURE
surv_censor <- survfit(Surv(time, event) ~ 1)
# summary(surv_censor)

# --- 3Ô∏è‚É£ PLOT COMPARATIF avec intervalle de confiance
# --- Plot comparatif avec intervalle de confiance
ggsurvplot_combine(
  list("Sans censure" = surv_no_censor, "Avec censure" = surv_censor),
  combine = TRUE,
  conf.int = TRUE,                   # activer l'intervalle de confiance
  conf.int.alpha = 0.25,             # transparence de la bande
  legend.title = NULL,
  legend.labs = c("Sans censure", "Avec censure"),
  palette = c("#1f78b4", "#e31a1c"), # bleu et rouge plus doux
  xlab = "Dur√©e du mariage (ann√©es)",
  ylab = "Probabilit√© de rester mari√©",
  title = "Comparaison des fonctions de survie : sans et avec censure",
  surv.median.line = "hv",           # ligne m√©diane horizontale/verticale
  risk.table.height = 0.25,
  ggtheme = theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      legend.position = "top",
      legend.text = element_text(size = 12)
    )
)
```

## Nelson-Aalen

### Estimateur Nelson-Aalen

## 2.1 Estimateur de Nelson-Aalen

L‚Äôestimateur de **Nelson-Aalen** permet d‚Äôestimer le **risque cumulatif** \(\Lambda(t)\) dans le cadre de donn√©es censur√©es.

Soit‚ÄØ:

- \(X\) : temps jusqu‚Äô√† l‚Äô√©v√©nement d‚Äôint√©r√™t (ex. divorce)  
- \(C\) : temps de censure (ex. fin de l‚Äô√©tude ou perte de suivi)  
- \(T = \min(X, C)\) : temps observ√© pour chaque individu  
 

On d√©finit‚ÄØ:

- \(H(t) = P(T > t) = P(X > t, C > t) = P(X > t)P(C > t)= S(t) G(t)\)  o√π \(G\) est la fonction de survie de la censure \(C\)  


- \(H_1(t) = P(T > t, \delta = 1) = P(X > t, C > X)\)  

On peut √©crire \(H_1(t)\) en fonction de la densit√© \(f(u)\) de \(X\) et de \(G(u)\) :

\[
\begin{aligned}
H_1(t) &= P(X > t,\, C > X) \\
&= E\big[ \mathbf{1}_{\{X > t\}} \cdot \mathbf{1}_{\{C > X\}} \big] \\[6pt]
&= E\Big[ \mathbf{1}_{\{X > t\}} \, E\big[\mathbf{1}_{\{C > X\}}\mid X\big] \Big] \\[6pt]
&= E\big[ \mathbf{1}_{\{X > t\}} \, P(C > X \mid X) \big] \\[6pt]
&= E\big[ \mathbf{1}_{\{X > t\}} \, G(X^-) \big] \\[6pt]
&= \displaystyle \int_{t}^{\infty} G(u^-) \, f(u)\,du \\[6pt]
&= - \displaystyle \int_{t}^{\infty} G(u^-) \, dS(u)
\end{aligned}
\]

On obtient donc :

\[ 
dH_1(t) = G(t^{-})dS(t)
\]

Et donc par le temps on obtient :

\[ 
\frac{dH_1(t)}{dt} = \frac{G(t^{-})dS(t)}{dt}
\]

ce qui donne math√©matiquement :

\[ 
H_1'(t) = G(t^{-})S'(t)
\]

Ainsi on a :

\[
\begin{aligned}
\hat{H}_{NA}(t) &= \displaystyle \int_{0}^{t} h(u) \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{S'(u)}{S(u)} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{\frac{H_1(u)}{G(u^{-})}}{\frac{H(u)}{G(u)}} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{H_1(u)}{H(u)}\frac{G(u)}{G(u^{-})} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{H_1(u)}{H(u)} \, du
\end{aligned}
\]

Un estimateur *naturel* s‚Äôobtient en rempla√ßant les fonctions \(H\) et \(H_1\) par leurs √©quivalents empiriques (calculables car les variables \(T\) et \(\delta\) sont observ√©es):

\[
\hat{H}(u) = \frac{1}{n} \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u\}}, \quad
\hat{H}_1(u) = \frac{1}{n} \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u, \delta_i = 1\}}
\]

L‚Äôestimateur de Nelson-Aalen est alors donn√© par‚ÄØ:

\[
\hat{H}_{NA}(t) = \displaystyle \int_{0}^{t} - \frac{\displaystyle \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u, \delta_i = 1\}}}{\displaystyle \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u\}}} \, du 
\]

Comme \(T\) est √† temps discret, l‚Äôint√©grale devient une **somme sur les temps d‚Äô√©v√©nement distincts**¬†, et on d√©finit alors pour chaque temps d‚Äô√©v√©nement \(t_i\)¬†:

\[
d_i = \sum_{j=1}^{n} \mathbf{1}_{\{T_j = t_i, \delta_j = 1\}}, 
\quad
n_i = \sum_{j=1}^{n} \mathbf{1}_{\{T_j \ge t_i\}}.
\]

Ce qui donne :

\[
\hat{H}_{NA}(t) = \sum_{t_i \le t} \frac{d_i}{n_i}.
\]


---

Une autre fa√ßon de calculer la fonction de risque cumul√©e et de passer par l'estimateur de beslow. 

\subsection*{3.1 Estimateur de Breslow du risque cumul√©}

Rappel : l'estimateur de Kaplan‚ÄìMeier de la fonction de survie s'√©crit, pour des temps d'√©v√©nement distincts \(t_1<\dots<t_m\),
\[
\hat{S}(t)=\prod_{t_i\le t}\left(1-\frac{d_i}{n_i}\right),
\]
o√π \(d_i\) est le nombre d'√©v√©nements au temps \(t_i\) et \(n_i\) le nombre d'individus √† risque juste avant \(t_i\).

En utilisant la relation
\[
H(t)=-\log S(t),
\]
on obtient l'estimateur de Breslow du risque cumul√© :
\[
\hat{H}_{\text{Breslow}}(t) 
= -\log\big(\hat{S}(t)\big)
= -\log\!\left(\prod_{t_i\le t}\left(1-\frac{d_i}{n_i}\right)\right)
= -\sum_{t_i\le t} \log\!\left(1-\frac{d_i}{n_i}\right).
\]

\bigskip

\textbf{Lien avec Nelson‚ÄìAalen.} Pour des fractions \(d_i/n_i\) petites, on utilise l'approximation
\(\log(1-x)\approx -x\) pour \(x\) proche de \(0\). Ainsi
\[
\sum_{t_i\le t}\log\!\left(1-\frac{d_i}{n_i}\right)
\approx \sum_{t_i\le t}\frac{d_i}{n_i},
\]
**Ce qui montre que l'estimateur de Breslow est proche (et asymptotiquement √©quivalent) √† l'estimateur de Nelson‚ÄìAalen**
\(\hat{H}_{NA}(t)=\sum_{t_i\le t}\dfrac{d_i}{n_i}\) lorsque les sauts sont petits.


```{r survival_without_parameters_2, echo = FALSE, fig.align='center'}
# Tableau combin√© Nelson-Aalen + Breslow
risk_methods <- data.frame(
  M√©thode = c("Nelson-Aalen", "Breslow"),
  Formule = c(
    "$\\hat{H}_{NA}(t) = \\sum_{t_i \\le t} \\dfrac{d_i}{n_i}$",
    "$\\hat{H}_{\\text{Breslow}}(t) = - \\sum_{t_i \\le t} \\log\\left(1 - \\dfrac{d_i}{n_i}\\right)$"
  ),
  Description = c(
    "Estimateur non param√©trique bas√© sur les √©v√©nements observ√©s et le nombre de sujets √† risque.",
    "Estimateur du risque cumulatif d√©riv√© de $H(t) = -\\log(S(t))$ via l'estimateur de Kaplan-Meier."
  ),
  stringsAsFactors = FALSE
)

kable(risk_methods, "html", escape = FALSE,
      caption = "üìä M√©thodes d‚Äôestimation du risque cumulatif : Nelson-Aalen et Breslow",
      align = c("c","c","c")) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  
  # Style colonne M√©thode (diff√©renci√©)
  column_spec(1, bold = TRUE, color = "black", background = c("#D6EAF8", "#F9E79F")) %>%
  
  # Largeur colonnes
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "8cm") %>%
  
  # Style ligne d'en-t√™te
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")


```

```{r survival_without_parameters_3, echo = FALSE, fig.align='center'}
# --- Donn√©es
time  <- data.brute$marriage_duration_years
event <- data.brute$divorced

km_fit <- survfit(Surv(time, event) ~ 1)
H_NA <- cumsum(km_fit$n.event / km_fit$n.risk)  # cumhaz de base
se_H_NA <- sqrt(cumsum(km_fit$n.event / (km_fit$n.risk^2)))  # Greenwood approx

df_na <- data.frame(
  time = km_fit$time,
  H_NA = H_NA,
  H_NA_lower = H_NA - 1.96 * se_H_NA,
  H_NA_upper = H_NA + 1.96 * se_H_NA
)


# --- Breslow : H(t) = -log(S(t))
km_fit <- survfit(Surv(time, event) ~ 1, type = "kaplan-meier")

df_breslow <- data.frame(
  time = km_fit$time,
  H_Breslow = -log(km_fit$surv),
  H_Breslow_lower = -log(km_fit$upper),
  H_Breslow_upper = -log(km_fit$lower)
)

# --- Fusion
df_merge <- merge(df_na, df_breslow, by = "time", all = TRUE)

library(ggplot2)

ggplot(df_merge, aes(x = time)) +

  # --- Nelson-Aalen avec IC ---
  geom_ribbon(aes(ymin = H_NA_lower, ymax = H_NA_upper),
              fill = "red", alpha = 0.15) +
  geom_line(aes(y = H_NA, color = "Nelson-Aalen"), size = 1.2) +

  # --- Breslow avec IC ---
  geom_ribbon(aes(ymin = H_Breslow_lower, ymax = H_Breslow_upper),
              fill = "blue", alpha = 0.15) +
  geom_line(aes(y = H_Breslow, color = "Breslow"),
            size = 1.2) +

  labs(
    title = "Comparaison des Estimateurs du Risque Cumulatif\nAvec intervalles de confiance √† 95%",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Risque cumulatif H(t)",
    color = "M√©thode"
  ) +
  scale_color_manual(values = c("Nelson-Aalen" = "red", "Breslow" = "blue")) +

  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom"
  )


```

### Estimateur de Nelson-Aalen sans et avec censure

```{r survival_without_parameters_4, echo = FALSE, fig.align='center'}
# --- Nelson-Aalen avec censure ---
km_fit_cens <- survfit(Surv(time, event) ~ 1)
H_NA_cens <- cumsum(km_fit_cens$n.event / km_fit_cens$n.risk)
se_H_NA_cens <- sqrt(cumsum(km_fit_cens$n.event / (km_fit_cens$n.risk^2)))

df_na_cens <- data.frame(
  time = km_fit_cens$time,
  H_NA = H_NA_cens,
  H_NA_lower = H_NA_cens - 1.96 * se_H_NA_cens,
  H_NA_upper = H_NA_cens + 1.96 * se_H_NA_cens
)

# --- Nelson-Aalen sans censure ---
event_no_cens <- rep(1, length(time))
km_fit_no_cens <- survfit(Surv(time, event_no_cens) ~ 1)
H_NA_no_cens <- cumsum(km_fit_no_cens$n.event / km_fit_no_cens$n.risk)
se_H_NA_no_cens <- sqrt(cumsum(km_fit_no_cens$n.event / (km_fit_no_cens$n.risk^2)))

df_na_no_cens <- data.frame(
  time = km_fit_no_cens$time,
  H_NA_no_cens = H_NA_no_cens,
  H_NA_no_cens_lower = H_NA_no_cens - 1.96 * se_H_NA_no_cens,
  H_NA_no_cens_upper = H_NA_no_cens + 1.96 * se_H_NA_no_cens
)

# --- Fusion ---
df_merge <- merge(df_na_cens, df_na_no_cens, by = "time", all = TRUE)

# --- Trac√© avec intervalles ---
ggplot(df_merge, aes(x = time)) +
  # ribbon pour les IC
  geom_ribbon(aes(ymin = H_NA_lower, ymax = H_NA_upper),
              fill = "blue", alpha = 0.15) +
  geom_ribbon(aes(ymin = H_NA_no_cens_lower, ymax = H_NA_no_cens_upper),
              fill = "red", alpha = 0.15) +
  # lignes estimateurs
  geom_line(aes(y = H_NA, color = "Avec censure"), size = 1.2) +
  geom_line(aes(y = H_NA_no_cens, color = "Sans censure"), size = 1.2) +
  labs(
    title = "Estimateur de Nelson-Aalen avec et sans censure",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Risque cumulatif H(t)",
    color = "M√©thode"
  ) +
  scale_color_manual(values = c("Avec censure" = "blue", "Sans censure" = "red")) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom"
  )


```


### Estimateur de Breslow sans et avec censure

```{r survival_without_parameters_5, echo = FALSE, fig.align='center'}
# --- Donn√©es ---
time  <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- Breslow avec censure ---
km_fit_cens <- survfit(Surv(time, event) ~ 1, type = "kaplan-meier")
df_breslow_cens <- data.frame(
  time = km_fit_cens$time,
  H_Breslow = -log(km_fit_cens$surv),
  H_Breslow_lower = -log(km_fit_cens$upper),
  H_Breslow_upper = -log(km_fit_cens$lower)
)

# --- Breslow sans censure ---
event_no_cens <- rep(1, length(time))  # tout le monde a eu l'√©v√©nement
km_fit_no_cens <- survfit(Surv(time, event_no_cens) ~ 1, type = "kaplan-meier")
df_breslow_no_cens <- data.frame(
  time = km_fit_no_cens$time,
  H_Breslow_no_cens = -log(km_fit_no_cens$surv),
  H_Breslow_no_cens_lower = -log(km_fit_no_cens$upper),
  H_Breslow_no_cens_upper = -log(km_fit_no_cens$lower)
)

# --- Fusion ---
df_merge <- merge(df_breslow_cens, df_breslow_no_cens, by = "time", all = TRUE)

# --- Trac√© avec intervalles de confiance ---
ggplot(df_merge, aes(x = time)) +
  # ribbons IC
  geom_ribbon(aes(ymin = H_Breslow_lower, ymax = H_Breslow_upper),
              fill = "blue", alpha = 0.15) +
  geom_ribbon(aes(ymin = H_Breslow_no_cens_lower, ymax = H_Breslow_no_cens_upper),
              fill = "red", alpha = 0.15) +
  # lignes estimateurs
  geom_line(aes(y = H_Breslow, color = "Breslow avec censure"), size = 1.2) +
  geom_line(aes(y = H_Breslow_no_cens, color = "Breslow sans censure"), size = 1.2) +
  labs(
    title = "Estimateur de Breslow : avec et sans censure",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Risque cumulatif H(t)",
    color = "M√©thode"
  ) +
  scale_color_manual(values = c("Breslow avec censure" = "blue", "Breslow sans censure" = "red")) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

```


