
```{r source survival_without_parameters, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
suppressPackageStartupMessages(source("setup.R"))
```

# - Analyse de survie

Notre base de donn√©es comporte une variable temporelle de dur√©e de survie caract√©ris√© par :

- `marriage_duration_years` : Mesure la **Dur√©e du mariage** de l'individu.

De plus, nous introduisons une variable \(a\) correspondant √† la borne inf√©rieure de la variable de survie. Ici, pour `marriage_duration_years`, on a \(a = 1\). Cette formalisation permet d‚Äôunifier la notation et de clarifier les domaines de d√©finition dans les d√©veloppements th√©oriques ult√©rieurs.

On pose $X$ la variable al√©atoire de survenue de l'√©v√®nement d'int√©r√™t, donc le divorce. On note donc les diff√©rentes fonctions de survie et leurs interpr√©tations par le tableau suivant :

```{r survival_without_parameters_0, echo = FALSE, fig.align='center'}


# D√©finition des colonnes
fonctions <- c("$S(t)$", "$H(t)$", "$h(t)$")

definitions <- c(
  "$S(t) = \\mathbb{P}(X \\gt t) = e^{-H(t)} = e^{-\\int_a^t h(u)\\,du}$",
  "$H(t) = \\int_a^t h(u)\\,du = -\\ln S(t)$",
  "$h(t) = -\\dfrac{S'(t)}{S(t)}$"
)

premier_temps <- c(
  "Probabilit√© que le mariage dure ‚â• t",
  "Risque cumul√© de divorce jusqu‚Äô√† t",
  "Risque instantan√© de divorce √† t"
)


# Cr√©ation du tableau
tableau <- data.frame(
  Fonction = fonctions,
  D√©finition = definitions,
  Dur√©e_du_mariage = premier_temps,
  stringsAsFactors = FALSE
)

# Affichage avec kable
kable(tableau, "html", caption = "üìä Interpr√©tation et d√©finitions des fonctions de survie", align = c("c","c","c","c")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, bold = TRUE, background = "#D6EAF8") %>%
  column_spec(2, background = "#EBF5FB") %>%
  column_spec(3, background = "#FDEBD0") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")

```

Nos donn√©es comportent une censure : certains individus n'ont pas encore connu l'√©v√©nement d'int√©r√™t, c'est √† dire qu'ils sont toujours encore mari√©s. Cette information est d√©j√† inscrite dans la base de donn√©es via la variable **`divorced`**, qui indique si l'individu est divorc√© ou non que l'on note :


$$
\delta_i =
\begin{cases}
1 & \text{si l'√©v√©nement divorce est observ√© pour } i \\
0 & \text{si l'observation n'est pas divorc√©}
\end{cases}
$$

## Censure

Soit \(X_i\) le temps de survie r√©el de l'individu \(i\) (dur√©e jusqu'√† l'√©v√©nement d'int√©r√™t, ici le divorce), et \(C_i\) la **variable al√©atoire du temps de censure**, repr√©sentant le moment auquel l'individu quitte l'√©tude ou n'a pas encore subi l'√©v√©nement.  

La dur√©e r√©ellement observ√©e pour chaque individu d√©pend du type de censure :  

- **Censure √† droite** : 
\[
T_i = \min(X_i, C_i)
\]
- **Censure √† gauche** : 
\[
T_i = \max(X_i, C_i)
\]

### Censure √† droite
La censure √† droite se produit lorsqu'un individu **n'a pas encore subi l'√©v√©nement d'int√©r√™t** (ici le divorce) au moment de sa derni√®re observation (\(X_i > C_i\)).  
Les principaux types de censure √† droite sont :  

- **Type I (fixe)** : tous les individus sont censur√©s au m√™me moment pr√©d√©termin√©.  
- **Type II** : l'√©tude s'arr√™te d√®s qu'un certain nombre d'√©v√©nements est observ√©.  
- **Type III (al√©atoire)** : le moment de censure varie d'un individu √† l'autre, par exemple √† cause de la fin de suivi variable, de pertes de vue ou d'arr√™ts de participation. Ce type est le plus courant dans les √©tudes observationnelles.

### Censure √† gauche
La censure √† gauche se produit lorsque l'√©v√©nement **a eu lieu avant le d√©but de l'observation**, et on ne conna√Æt que la borne sup√©rieure du temps de survie (\(X_i < C_i\)).  
Elle est beaucoup plus rare dans les √©tudes humaines et moins souvent trait√©e dans la litt√©rature.

### Censure par intervalle
Une censure par intervalle survient lorsqu‚Äôon sait seulement que l‚Äô√©v√©nement s‚Äôest produit **entre deux dates d‚Äôobservation**. Dans la pratique, elle est souvent convertie en censure √† droite pour simplifier l'analyse.

---

Dans notre base de donn√©es, certains mariages **n'ont pas abouti √† un divorce au moment de la fin de l'√©tude**, et le temps de suivi varie selon les individus.  
On en d√©duit que les donn√©es pr√©sentent une **censure √† droite de type III (al√©atoire)**.  
On suppose que cette censure est **non informative**, c'est-√†-dire ind√©pendante de la probabilit√© de divorce, conform√©ment aux hypoth√®ses classiques des mod√®les de survie.  

Dans ce contexte, la **dur√©e r√©ellement observ√©e** pour chaque mariage est donn√©e par :

\[
T = \min(X, C)
\]

## - Estimateur de la Fonction de survie S(t)

**Estimateur empirique de la fonction de survie :**

$$
\hat{S}(t) = \frac{1}{n} \sum_{i=1}^{n} \boldsymbol{1}_{\{t_i > t\}}
$$

- \( n \) = nombre total d'observations  
- \( t_i \) = temps jusqu‚Äô√† l‚Äô√©v√©nement pour l‚Äôindividu \( i \)  
- \( \boldsymbol{1}_{\{t_i > t\}} \) = indicateur qui vaut 1 si l‚Äôindividu n‚Äôa pas encore eu l‚Äô√©v√©nement √† \( t \), 0 sinon  

Cet estimateur correspond simplement √† la proportion d‚Äôindividus encore mari√©s au temps \( t \).  
Il suppose qu‚Äôil **n‚Äôy a aucune donn√©e censur√©e**, c‚Äôest-√†-dire que tous les individus ont eu l‚Äô√©v√©nement observ√©.

```{r iajzjbflkakf, echo = FALSE, fig.align='center'}
# Tableau Kaplan‚ÄìMeier SANS CENSURE (variance binomiale)
km_methods_no_censor <- data.frame(
  M√©thode = c(
    "Estimateur empirique de survie (sans censure)",
    "Variance (loi binomiale, cas sans censure)",
    "Intervalle de confiance plain √† 95 %"
  ),
  
  Formule = c(
    # Kaplan‚ÄìMeier simplifi√© sans censure
    "$\\hat{S}(t) = 1 - F_n(t) = \\frac{\\text{nombre d'individus survivants √† } t}{n}$",
    
    # Variance binomiale
    "$\\widehat{\\text{Var}}[\\hat{S}(t)] = \\frac{\\hat S(t) (1 - \\hat S(t))}{n}$",
    
    # IC plain
    "$\\text{IC}_{95\\%}(t)=
      \\hat S(t)^{\\,
      \\exp\\left(
      \\pm 1.96
      \\sqrt{
      \\dfrac{
      \\widehat{\\text{Var}}[\\hat S(t)]
      }{
      \\hat S(t)^2
      }}
      \\right)
      }$"
  ),
  
  Description = c(
    "Dans le cas sans censure, Kaplan‚ÄìMeier co√Øncide avec l‚Äôestimateur empirique de la fonction de survie.",
    "Variance estim√©e selon la loi binomiale, adapt√©e aux donn√©es enti√®rement observ√©es.",
    "Intervalle de confiance classique bas√© sur la variance binomiale."
  ),
  
  stringsAsFactors = FALSE
)

# Affichage du tableau
kable(km_methods_no_censor, "html", escape = FALSE,
      caption = "üìä Estimateur de survie sans censure, variance binomiale et intervalle de confiance plain √† 95 %",
      align = c("c","c","c")) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black",
              background = c("#D6EAF8", "#F9E79F", "#FDEDEC")) %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "8cm") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")

```


---

## - Estimateur avec censure (Kaplan-Meier)

L'estimateur de Kaplan-Meier d√©coule de l'id√©e suivante : survivre apr√®s un temps \(t_n\) revient √† √™tre vivant juste avant \(t_n\) et **ne pas subir l'√©v√©nement √† ce temps**. Formellement, pour \(t_0 < t_1 < \dots < t_{n-1} < t_n\) :

La probabilit√© de survie jusqu‚Äô√† \(t_n\) peut s‚Äô√©crire en utilisant la **r√®gle de multiplication des probabilit√©s**‚ÄØ:

\[
\mathbb{P}(X > t_n) = \mathbb{P}(X > t_1, X > t_2, \dots, X > t_n)
\]

On introduit une r√©currence‚ÄØ: pour tout \(k \ge 1\),

\[
\mathbb{P}(X > t_k \mid X > t_{k-1}, \dots, X > t_1) = \mathbb{P}(X > t_k \mid X > t_{k-1})
\]

o√π l‚Äô√©galit√© d√©coule de l‚Äôind√©pendance conditionnelle induite par l‚Äôordre croissant des temps.  

Ainsi, par r√©currence sur les indices \(k\) :

\[
\begin{aligned}
\mathbb{P}(X > t_1, X > t_2, \dots, X > t_n) 
&= \mathbb{P}(X > t_1) \cdot \mathbb{P}(X > t_2 \mid X > t_1) \\
&\quad \cdot \mathbb{P}(X > t_3 \mid X > t_1, X > t_2) \cdots \mathbb{P}(X > t_n \mid X > t_1, \dots, X > t_{n-1}) \\
&= \mathbb{P}(X > t_1) \prod_{k=2}^{n} \mathbb{P}(X > t_k \mid X > t_{k-1})
\end{aligned}
\]

On consid√®re les temps d‚Äô√©v√©nements distincts \(T_{(1)} < T_{(2)} < \dots < T_{(j)}\) (d√©c√®s ou divorce observ√©s) rang√©s par ordre croissant.  
On d√©finit \(T_{(0)} = 0\), la borne inf√©rieure du temps (par exemple \(a=1\) pour la dur√©e de mariage).  

Ainsi, la probabilit√© de survie jusqu‚Äôau temps \(T_{(j)}\) peut s‚Äô√©crire comme un **produit de probabilit√©s conditionnelles** :

\[
\begin{aligned}
\mathbb{P}(X > T_{(j)}) 
&= \prod_{k=1}^{j} \mathbb{P}(X > T_{(k)} \mid X > T_{(k-1)})
\end{aligned}
\]

Pour chaque temps d‚Äô√©v√©nement \(T_{(k)}\), on s‚Äôint√©resse √† la probabilit√© conditionnelle de **subir l‚Äô√©v√©nement √† ce temps**, sachant que l‚Äôindividu √©tait encore √† risque juste avant :

\[
\mathbb{P}(X \le T_{(k)} \mid X > T_{(k-1)})
\]

Cette quantit√© repr√©sente la probabilit√© qu‚Äôun individu qui a ¬´ surv√©cu ¬ª jusqu‚Äô√† \(T_{(k-1)}\) subisse l‚Äô√©v√©nement √† \(T_{(k)}\).  

En pratique, on dispose des donn√©es observ√©es :  

- \(n_k\) = nombre d‚Äôindividus **encore √† risque** juste avant \(T_{(k)}\)  
- \(d_k\) = nombre d‚Äô√©v√©nements observ√©s √† \(T_{(k)}\)  

On peut alors **estimer cette probabilit√© conditionnelle** par :

\[
\hat{\mathbb{P}}(X \le T_{(k)} \mid X > T_{(k-1)}) = \frac{d_k}{n_k}
\]

La probabilit√© de **survivre** au temps \(T_{(k)}\) est le compl√©mentaire :

\[
\hat{q}_k = \hat{\mathbb{P}}(X \ge T_{(k)} \mid X > T_{(k-1)}) = 1 - \hat{\mathbb{P}}(X \le T_{(k)} \mid X > T_{(k-1)}) = 1 - \frac{d_k}{n_k}
\]

Enfin, en rempla√ßant les probabilit√©s conditionnelles dans le produit de survie, on obtient l‚Äô**estimateur de Kaplan-Meier** (ou produit-limite) :

\[
\hat{S}(t) = \prod_{T_{(k)} \le t} \hat{q}_k = \prod_{T_{(k)} \le t} \left( 1 - \frac{d_k}{n_k} \right)
\]

Ainsi, l‚Äôestimateur de Kaplan-Meier **corrige naturellement le biais d√ª √† la censure** et fournit une estimation non param√©trique de la fonction de survie.

```{r kakuzhfdjahd, echo = FALSE, fig.align='center'}
# Tableau Kaplan-Meier + variance + intervalle de confiance (log)
km_methods <- data.frame(
  M√©thode = c(
    "Kaplan-Meier",
    "Variance de Greenwood",
    "Intervalle de confiance log √† 95 %"
  ),
  
  Formule = c(
    # Kaplan‚ÄìMeier
    "$\\hat{S}(t) = \\prod_{T_{(k)} \\le t} \\left( 1 - \\dfrac{d_k}{n_k} \\right)$",
    
    # Greenwood
    "$\\widehat{\\text{Var}}\\left[\\hat{S}(t)\\right] 
      = \\hat{S}(t)^2 
      \\sum_{T_{(k)} \\le t} 
      \\dfrac{d_k}{n_k (n_k - d_k)}$",
    
    # Intervalle log
    "$\\text{IC}_{95\\%}(t)=
      \\hat S(t)^{\\,
      \\exp\\left(
      \\pm 1.96
      \\sqrt{
      \\dfrac{
      \\widehat{\\text{Var}}[\\hat S(t)]
      }{
      \\hat S(t)^2
      }}
      \\right)
      }$"
  ),
  
  Description = c(
    "Estimateur non param√©trique de la fonction de survie bas√© sur les √©v√©nements observ√©s et le nombre d'individus √† risque.",
    "Variance estim√©e de Kaplan-Meier selon la formule de Greenwood.",
    "Intervalle de confiance construit via une transformation logarithmique de S(t), qui est la m√©thode par d√©faut de survfit()."
  ),
  
  stringsAsFactors = FALSE
)

# Affichage tableau
kable(km_methods, "html", escape = FALSE,
      caption = "üìä Estimateur de Kaplan-Meier, variance de Greenwood et intervalle de confiance log √† 95 %",
      align = c("c","c","c")) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black",
              background = c("#D6EAF8", "#F9E79F", "#FDEDEC")) %>%
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "8cm") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")


```

```{r survival_without_parameters_1, echo = FALSE, fig.align='center'}
# --- Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- Survie sans censure avec IC
surv_no_censor <- survfit(Surv(time, rep(1, length(time))) ~ 1, conf.type = "plain")
n_no <- length(surv_no_censor$time)

# --- Survie avec censure avec IC
surv_censor <- survfit(Surv(time, event) ~ 1, conf.type = "plain")

# --- Plot Plotly avec IC
fig <- plot_ly() %>%
  # Sans censure
  add_lines(x = surv_no_censor$time[-n_no],
            y = surv_no_censor$surv[-n_no],
            name = "Sans censure",
            line = list(color = "#1f78b4")) %>%
  add_ribbons(x = surv_no_censor$time[-n_no],
              ymin = surv_no_censor$lower[-n_no],
              ymax = surv_no_censor$upper[-n_no],
              fillcolor = "#1f78b433",
              line = list(color = "transparent"),
              showlegend = FALSE) %>%
  # Avec censure
  add_lines(x = surv_censor$time,
            y = surv_censor$surv,
            name = "Avec censure",
            line = list(color = "#e31a1c")) %>%
  add_ribbons(x = surv_censor$time,
              ymin = surv_censor$lower,
              ymax = surv_censor$upper,
              fillcolor = "#e31a1c33",
              line = list(color = "transparent"),
              showlegend = FALSE) %>%
  layout(title = "Comparaison des fonctions de survie : sans et avec censure",
         xaxis = list(title = "Dur√©e du mariage (ann√©es)"),
         yaxis = list(title = "Probabilit√© de rester mari√©"),
         legend = list(x = 0.1, y = 0.95))

fig

```

## - Estimateur de Nelson-Aalen

L‚Äôestimateur de **Nelson-Aalen** permet d‚Äôestimer le **risque cumulatif** \(h(t)\) dans le cadre de donn√©es censur√©es.

On d√©finit‚ÄØ:

- \(H(t) = \mathbb{P}(T > t) = \mathbb{P}(X > t, C > t) = \mathbb{P}(X > t)\mathbb{P}(C > t)= S(t) G(t)\)  o√π \(G\) est la fonction de survie de la censure \(C\)  


- \(H_1(t) = \mathbb{P}(T > t, \delta = 1) = \mathbb{P}(X > t, C > X)\)  

On peut √©crire \(H_1(t)\) en fonction de la densit√© \(f(u)\) de \(X\) et de \(G(u)\) :

\[
\begin{aligned}
H_1(t) &= \mathbb{P}(X > t,\, C > X) \\
&= \mathbb{E}\big[ \mathbf{1}_{\{X > t\}} \cdot \mathbf{1}_{\{C > X\}} \big] \\[6pt]
&= \mathbb{E}\Big[ \mathbf{1}_{\{X > t\}} \, \mathbb{E}\big[\mathbf{1}_{\{C > X\}}\mid X\big] \Big] \\[6pt]
&= \mathbb{E}\big[ \mathbf{1}_{\{X > t\}} \, \mathbb{P}(C > X \mid X) \big] \\[6pt]
&= \mathbb{E}\big[ \mathbf{1}_{\{X > t\}} \, G(X^-) \big] \\[6pt]
&= \displaystyle \int_{t}^{\infty} G(u^-) \, f(u)\,du \\[6pt]
&= - \displaystyle \int_{t}^{\infty} G(u^-) \, dS(u)
\end{aligned}
\]

On obtient donc :

\[ 
dH_1(t) = G(t^{-})dS(t)
\]

Et donc par le temps on obtient :

\[ 
\frac{dH_1(t)}{dt} = \frac{G(t^{-})dS(t)}{dt}
\]

ce qui donne math√©matiquement :

\[ 
H_1'(t) = G(t^{-})S'(t)
\]

Ainsi on a :

\[
\begin{aligned}
\hat{H}_{NA}(t) &= \displaystyle \int_{0}^{t} h(u) \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{S'(u)}{S(u)} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{\frac{H_1(u)}{G(u^{-})}}{\frac{H(u)}{G(u)}} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{H_1(u)}{H(u)}\frac{G(u)}{G(u^{-})} \, du \\[2mm]
&= \displaystyle \int_{0}^{t} -\frac{H_1(u)}{H(u)} \, du
\end{aligned}
\]

Un estimateur *naturel* s‚Äôobtient en rempla√ßant les fonctions \(H\) et \(H_1\) par leurs √©quivalents empiriques (calculables car les variables \(T\) et \(\delta\) sont observ√©es):

\[
\hat{H}(u) = \frac{1}{n} \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u\}}, \quad
\hat{H}_1(u) = \frac{1}{n} \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u, \delta_i = 1\}}
\]

L‚Äôestimateur de Nelson-Aalen est alors donn√© par‚ÄØ:

\[
\hat{H}_{NA}(t) = \displaystyle \int_{0}^{t} - \frac{\displaystyle \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u, \delta_i = 1\}}}{\displaystyle \sum_{i=1}^{n} \mathbf{1}_{\{T_i > u\}}} \, du 
\]

Comme \(T\) est √† temps discret, l‚Äôint√©grale devient une **somme sur les temps d‚Äô√©v√©nement distincts**¬†, et on d√©finit alors pour chaque temps d‚Äô√©v√©nement \(t_i\)¬†:

\[
d_i = \sum_{j=1}^{n} \mathbf{1}_{\{T_j = t_i, \delta_j = 1\}}, 
\quad
n_i = \sum_{j=1}^{n} \mathbf{1}_{\{T_j \ge t_i\}}.
\]

Ce qui donne :

\[
\hat{H}_{NA}(t) = \sum_{t_i \le t} \frac{d_i}{n_i}.
\]


---

Une autre fa√ßon de calculer la fonction de risque cumul√©e et de passer par l'estimateur de beslow. 

\subsection*{3.1 Estimateur de Breslow du risque cumul√©}

Rappel : l'estimateur de Kaplan‚ÄìMeier de la fonction de survie s'√©crit, pour des temps d'√©v√©nement distincts \(t_1<\dots<t_m\),
\[
\hat{S}(t)=\prod_{t_i\le t}\left(1-\frac{d_i}{n_i}\right),
\]
o√π \(d_i\) est le nombre d'√©v√©nements au temps \(t_i\) et \(n_i\) le nombre d'individus √† risque juste avant \(t_i\).

En utilisant la relation
\[
H(t)=-\log S(t),
\]
on obtient l'estimateur de Breslow du risque cumul√© :
\[
\hat{H}_{\text{Breslow}}(t) 
= -\log\big(\hat{S}(t)\big)
= -\log\!\left(\prod_{t_i\le t}\left(1-\frac{d_i}{n_i}\right)\right)
= -\sum_{t_i\le t} \log\!\left(1-\frac{d_i}{n_i}\right).
\]

\bigskip

\textbf{Lien avec Nelson‚ÄìAalen.} Pour des fractions \(d_i/n_i\) petites, on utilise l'approximation
\(\log(1-x)\approx -x\) pour \(x\) proche de \(0\). Ainsi
\[
\sum_{t_i\le t}\log\!\left(1-\frac{d_i}{n_i}\right)
\approx \sum_{t_i\le t}\frac{d_i}{n_i},
\]
**Ce qui montre que l'estimateur de Breslow est proche (et asymptotiquement √©quivalent) √† l'estimateur de Nelson‚ÄìAalen**
\(\hat{H}_{NA}(t)=\sum_{t_i\le t}\dfrac{d_i}{n_i}\) lorsque les sauts sont petits.


```{r survival_without_parameters_2, echo = FALSE, fig.align='center'}
# Tableau combin√© Nelson-Aalen + Breslow
risk_methods <- data.frame(
  M√©thode = c("Nelson-Aalen", "Breslow"),
  Formule = c(
    "$\\hat{H}_{NA}(t) = \\sum_{t_i \\le t} \\dfrac{d_i}{n_i}$",
    "$\\hat{H}_{\\text{Breslow}}(t) = - \\sum_{t_i \\le t} \\log\\left(1 - \\dfrac{d_i}{n_i}\\right)$"
  ),
  Description = c(
    "Estimateur non param√©trique bas√© sur les √©v√©nements observ√©s et le nombre de sujets √† risque.",
    "Estimateur du risque cumulatif d√©riv√© de $H(t) = -\\log(S(t))$ via l'estimateur de Kaplan-Meier."
  ),
  stringsAsFactors = FALSE
)

kable(risk_methods, "html", escape = FALSE,
      caption = "üìä M√©thodes d‚Äôestimation du risque cumulatif : Nelson-Aalen et Breslow",
      align = c("c","c","c")) %>%
  kable_styling(bootstrap_options = c("striped","hover","condensed"), full_width = FALSE) %>%
  
  # Style colonne M√©thode (diff√©renci√©)
  column_spec(1, bold = TRUE, color = "black", background = c("#D6EAF8", "#F9E79F")) %>%
  
  # Largeur colonnes
  column_spec(2, width = "6cm") %>%
  column_spec(3, width = "8cm") %>%
  
  # Style ligne d'en-t√™te
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")


```

```{r survival_without_parameters_3, echo = FALSE, fig.align='center'}
# --- Donn√©es
time  <- data.brute$marriage_duration_years
event <- data.brute$divorced

km_fit <- survfit(Surv(time, event) ~ 1)
H_NA <- cumsum(km_fit$n.event / km_fit$n.risk)  # cumhaz de base
se_H_NA <- sqrt(cumsum(km_fit$n.event / (km_fit$n.risk^2)))  # Greenwood approx

df_na <- data.frame(
  time = km_fit$time,
  H_NA = H_NA,
  H_NA_lower = H_NA - 1.96 * se_H_NA,
  H_NA_upper = H_NA + 1.96 * se_H_NA
)


# --- Breslow : H(t) = -log(S(t))
km_fit <- survfit(Surv(time, event) ~ 1, type = "kaplan-meier")

df_breslow <- data.frame(
  time = km_fit$time,
  H_Breslow = -log(km_fit$surv),
  H_Breslow_lower = -log(km_fit$upper),
  H_Breslow_upper = -log(km_fit$lower)
)

# --- Fusion
df_merge <- merge(df_na, df_breslow, by = "time", all = TRUE)

library(ggplot2)

ggplot(df_merge, aes(x = time)) +

  # --- Nelson-Aalen avec IC ---
  geom_ribbon(aes(ymin = H_NA_lower, ymax = H_NA_upper),
              fill = "red", alpha = 0.15) +
  geom_line(aes(y = H_NA, color = "Nelson-Aalen"), size = 1.2) +

  # --- Breslow avec IC ---
  geom_ribbon(aes(ymin = H_Breslow_lower, ymax = H_Breslow_upper),
              fill = "blue", alpha = 0.15) +
  geom_line(aes(y = H_Breslow, color = "Breslow"),
            size = 1.2) +

  labs(
    title = "Comparaison des Estimateurs du Risque Cumulatif\nAvec intervalles de confiance √† 95%",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Risque cumulatif H(t)",
    color = "M√©thode"
  ) +
  scale_color_manual(values = c("Nelson-Aalen" = "red", "Breslow" = "blue")) +

  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom"
  )


```

### - Estimateur de Breslow sans et avec censure

```{r survival_without_parameters_5, echo = FALSE, fig.align='center'}
# --- Donn√©es ---
time  <- data.brute$marriage_duration_years
event <- data.brute$divorced

# --- Breslow avec censure ---
km_fit_cens <- survfit(Surv(time, event) ~ 1, type = "kaplan-meier")
df_breslow_cens <- data.frame(
  time = km_fit_cens$time,
  H_Breslow = -log(km_fit_cens$surv),
  H_Breslow_lower = -log(km_fit_cens$upper),
  H_Breslow_upper = -log(km_fit_cens$lower)
)

# --- Breslow sans censure ---
event_no_cens <- rep(1, length(time))  # tout le monde a eu l'√©v√©nement
km_fit_no_cens <- survfit(Surv(time, event_no_cens) ~ 1, type = "kaplan-meier")
df_breslow_no_cens <- data.frame(
  time = km_fit_no_cens$time,
  H_Breslow_no_cens = -log(km_fit_no_cens$surv),
  H_Breslow_no_cens_lower = -log(km_fit_no_cens$upper),
  H_Breslow_no_cens_upper = -log(km_fit_no_cens$lower)
)

# --- Fusion ---
df_merge <- merge(df_breslow_cens, df_breslow_no_cens, by = "time", all = TRUE)

# --- Trac√© avec intervalles de confiance ---
ggplot(df_merge, aes(x = time)) +
  # ribbons IC
  geom_ribbon(aes(ymin = H_Breslow_lower, ymax = H_Breslow_upper),
              fill = "blue", alpha = 0.15) +
  geom_ribbon(aes(ymin = H_Breslow_no_cens_lower, ymax = H_Breslow_no_cens_upper),
              fill = "red", alpha = 0.15) +
  # lignes estimateurs
  geom_line(aes(y = H_Breslow, color = "Breslow avec censure"), size = 1.2) +
  geom_line(aes(y = H_Breslow_no_cens, color = "Breslow sans censure"), size = 1.2) +
  labs(
    title = "Estimateur de Breslow : avec et sans censure",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Risque cumulatif H(t)",
    color = "M√©thode"
  ) +
  scale_color_manual(values = c("Breslow avec censure" = "blue", "Breslow sans censure" = "red")) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

```

```{r survival_without_parameters_6, echo = FALSE, fig.align='center'}
# --- Donn√©es ---
time  <- data.brute$marriage_duration_years
event <- data.brute$divorced

fit <- survfit(Surv(time, event) ~ 1, type = "kaplan-meier")

# --- Estimation de h(t) ---
# h(t_i) = di / Yi
hazard <- fit$n.event / fit$n.risk

# --- Cr√©ation d'un data.frame pour ggplot ---
df_hazard <- data.frame(
  time = fit$time,
  hazard = hazard
)

# --- Trac√© ---
ggplot(df_hazard, aes(x = time, y = hazard)) +
  geom_step(color = "darkgreen", size = 1.2) +
  labs(
    title = "Estimation du taux de risque instantan√© h(t)",
    x = "Dur√©e du mariage (ann√©es)",
    y = "Taux de risque h(t)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold")
  )

```