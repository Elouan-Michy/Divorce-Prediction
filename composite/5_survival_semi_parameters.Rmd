```{r source survival_semi_parameters, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
suppressPackageStartupMessages(source("setup.R"))
```

# Mod√®le Cox

On se place dans le cadre du mod√®le de Cox. La fonction de risque conditionnelle s‚Äô√©crit

\[
h(t \mid X) = h_0(t)\exp(\beta^T X),
\]

o√π :

- \(X = (X_1, X_2, \dots, X_p)^T\) est le vecteur de covariables de dimension \(p \times 1\),
- \(\beta = (\beta_1, \beta_2, \dots, \beta_p)^T\) est le vecteur de coefficients de r√©gression.
- \( h_0(t) \) est le risque instantan√© d'√©v√®nement quand toutes les covariables valent z√©ros.

Consid√©rons :

- \(D\) le nombre d‚Äô√©v√©nements **divorce** observ√©s parmi les \(n\) sujets de l‚Äô√©tude,
- \(T_1 < T_2 < \dots < T_D\) les temps distincts de divorce,
- \(R(T_i)\) l‚Äôensemble des individus encore √† risque de divorce juste avant le temps \(T_i\) (toujours mari√©s √† \(T_i^-\)).

Si l'on compare le risque instantan√© d‚Äôun individu ayant \(X_j = 1\) √† celui d‚Äôun individu de r√©f√©rence dont toutes les covariables valent z√©ro (\(X = 0\)), on a :

\[
\frac{h\bigl(t \,\big|\, X_j = 1, \, X_i = 0 \ \forall i \neq j\bigr)}{h_0(t \mid X = 0)} = \exp(\beta_j) = \text{HR}_j
\]

En pratique, le HR indique combien de fois le risque instantan√© est multipli√© pour une augmentation d‚Äôune unit√© de la covariable \(X_j\), compar√© √† un individu de r√©f√©rence avec toutes les autres covariables √† z√©ro.

##  Tests d‚Äôhypoth√®ses globaux

√Ä partir de la log-vraisemblance partielle, on peut estimer le vecteur de param√®tres Œ≤ de dimension \(p \times 1\) :

\[
L(\beta) = \log L_{\text{Cox}}(\beta) 
= \sum_{i=1}^{D} \left[ \beta^T X_{(i)} - \log \left( \sum_{j \in R(T_i)} \exp(\beta^T X_j) \right) \right],
\]

La fonction score \(U(\beta)\) est le vecteur des d√©riv√©es premi√®res de la log-vraisemblance :

\[
U(\beta) = \frac{\partial L(\beta)}{\partial \beta} 
= \sum_{i=1}^{D} \left[ X_{(i)} - \frac{\sum_{j \in R(T_i)} X_j \exp(\beta^T X_j)}{\sum_{j \in R(T_i)} \exp(\beta^T X_j)} \right]
= \begin{pmatrix}
\frac{\partial L(\beta)}{\partial \beta_1} \\[1mm]
\vdots \\[1mm]
\frac{\partial L(\beta)}{\partial \beta_p}
\end{pmatrix}.
\]

Un estimateur consistant de la matrice de variance-covariance de \(\hat{\beta}\) est donn√© par l‚Äôinverse de la matrice d‚Äôinformation de Fisher :

\[
\mathrm{Var}(\hat{\beta}) = \hat{I}(\hat{\beta})^{-1}, \quad \text{avec } 
[I(\beta)]_{i,j} = - \frac{\partial^2 L(\beta)}{\partial \beta_i \partial \beta_j}.
\]

On souhaite tester :

\[
\begin{cases}
H_0: \beta_1 = \dots = \beta_p = 0 \\[1mm]
H_1: \exists j \in \{1,\dots,p\} \text{ tel que } \beta_j \neq 0
\end{cases}
\]

Trois statistiques sont classiquement utilis√©es :

1. **Test du rapport de vraisemblance (Likelihood Ratio Test)** :

\[
\chi^2_{\text{LRT}} = 2 \left[ \log L_{\text{Cox}}(\hat{\beta}) - \log L_{\text{Cox}}(\beta_0) \right]
\sim \chi^2_p \text{ sous } H_0
\]

2. **Test de Wald** :

\[
\chi^2_W = (\hat{\beta} - \beta_0)^T I(\hat{\beta}) (\hat{\beta} - \beta_0)
\sim \chi^2_p \text{ sous } H_0
\]

3. **Test de Score (ou logrank)** :

\[
\chi^2_S = U(\beta_0)^T I(\beta_0)^{-1} U(\beta_0) \sim \chi^2_p \text{ sous } H_0
\]

Toutes ces statistiques suivent une loi du chi-deux √† \(p\) degr√©s de libert√© sous l‚Äôhypoth√®se nulle. Elles permettent de d√©terminer si au moins une covariable a un effet significatif sur le risque de l‚Äô√©v√©nement. De plus \(\beta_0\) = 0 dans cette section.

```{r survival_semi_parameters_0, echo = TRUE, fig.align='center'}
# Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

# Mod√®le de Cox
cox_all <- coxph(
  Surv(time, event) ~ . - divorced - marriage_duration_years,
  data = data.brute
)

model_cox <- summary(cox_all)

# R√©sultats des tests globaux
cat(
  "Likelihood ratio test =", model_cox$logtest[1], "on", model_cox$logtest[2], "df, p=", signif(model_cox$logtest[3], 3), "\n",
  "Wald test            =", model_cox$waldtest[1], "on", model_cox$waldtest[2], "df, p=", signif(model_cox$waldtest[3], 3), "\n",
  "Score (logrank) test =", model_cox$sctest[1], "on", model_cox$sctest[2], "df, p=", signif(model_cox$sctest[3], 3), "\n"
)


```

> Le mod√®le de Cox ajust√© pour les covariables √©tudi√©es est globalement significatif. Les trois tests globaux Likelihood ratio, Wald et Score (logrank) donnent des statistiques √©lev√©es avec des p-values tr√®s faibles (respectivement 1.54e-12, 4.21e-13 et 3.71e-13). Sous l‚Äôhypoth√®se nulle, ces tests √©valuent si tous les coefficients des covariables sont nuls, c‚Äôest-√†-dire si aucune covariable n‚Äôa d‚Äôeffet sur le risque de divorce. Le rejet de cette hypoth√®se nulle indique qu‚Äôau moins une covariable a un effet significatif sur le risque de divorce, justifiant l‚Äôexamen des coefficients individuels pour identifier quelles covariables contribuent de mani√®re significative au mod√®le.

## Tests par covariable

La colonne `Pr(>|z|)` correspond au **test de Wald pour chaque coefficient individuel**.

Chaque covariable a sa propre hypoth√®se nulle :

\[
H_0 : \beta_j = 0 \quad \text{vs} \quad H_1 : \beta_j \neq 0
\]

La statistique utilis√©e est la **statistique de Wald par covariable** :

\[
z_j = \frac{\hat{\beta}_j}{\text{SE}(\hat{\beta}_j)}, \quad
\text{p-value} = 2 \cdot \Pr(|Z| > |z_j|),
\]

o√π \(\hat{\beta}_j\) est l‚Äôestimation du coefficient et \(\text{SE}(\hat{\beta}_j)\) son erreur-type tel que \( \text{SE}(\hat{\beta}_j) = \sqrt{\text{Var}(\hat{\beta}_j)} = \sqrt{\left[ \hat{I}(\hat{\beta})^{-1} \right]_{jj}}, \)
.

```{r survival_semi_parameters_1, echo = TRUE, fig.align='center'}
# Donn√©es
time <- data.brute$marriage_duration_years
event <- data.brute$divorced

cox_all <- coxph(
  Surv(time, event) ~ . - divorced - marriage_duration_years,
  data = data.brute
)

model_cox <- summary(cox_all)

model_cox$coefficients

```
En regardant donc les coefficients, on observe de nombreuses variables ayant un effet significatif sur le mod√®le.

La compatibilit√© religieuse appara√Æt comme un facteur protecteur : les couples o√π la personne n‚Äôest pas religieuse ont un hazard ratio de 0.849, ce qui correspond √† une r√©duction du risque de divorce d‚Äôenviron 15 % par rapport √† la cat√©gorie de r√©f√©rence. Cet effet est statistiquement significatif (z = -2.27, p = 0.0232), indiquant que l‚Äôabsence de religion r√©duit l√©g√®rement mais de mani√®re significative le risque de rupture.

La qualit√© de la communication entre partenaires a un effet protecteur important. Chaque augmentation d‚Äôune unit√© du score de communication est associ√©e √† un hazard ratio de 0.953, soit une diminution du risque de divorce d‚Äôenviron 4,7 %, avec une tr√®s forte significativit√© statistique (z = -4.26, p = 2.0e-05). Cela indique que de meilleures comp√©tences en communication r√©duisent le risque de divorce.

Le stress financier augmente le risque de divorce : chaque unit√© suppl√©mentaire dans le niveau de stress financier est associ√©e √† un hazard ratio de 1.028, soit une augmentation du risque de divorce d‚Äôenviron 2,8 %, avec z = 2.80 et p = 0.0051.

Les probl√®mes de sant√© mentale accroissent √©galement le risque de divorce. Les couples o√π un partenaire pr√©sente des probl√®mes de sant√© mentale ont un hazard ratio de 1.174, ce qui correspond √† une augmentation du risque de divorce d‚Äôenviron 17,4 %, z = 2.95, p = 0.0031.

L‚Äôinfid√©lit√© est un facteur de risque majeur : les couples o√π l‚Äôinfid√©lit√© est survenue ont un hazard ratio de 1.270, soit une augmentation du risque de divorce d‚Äôenviron 27 %, z = 4.07, p = 4.6e-05.

L‚Äôhistorique de violence domestique est le facteur le plus impactant observ√© : les couples ayant un tel historique pr√©sentent un hazard ratio de 1.443, correspondant √† une augmentation du risque de divorce d‚Äôenviron 44,3 %, avec z = 4.18 et p = 2.9e-05.

Enfin, le niveau de confiance est fortement protecteur : chaque unit√© suppl√©mentaire dans le score de confiance est associ√©e √† un hazard ratio de 0.949, soit une r√©duction du risque de divorce d‚Äôenviron 5,1 %, avec une significativit√© tr√®s √©lev√©e (z = -4.60, p = 4.1e-06).

Ces r√©sultats montrent que les facteurs relationnels (communication, confiance, infid√©lit√©, violence domestique), psychologiques (probl√®mes de sant√© mentale) et financiers (stress financier) ont un impact significatif sur la stabilit√© du mariage. Les variables avec HR < 1 r√©duisent le risque de divorce, tandis que celles avec HR > 1 l‚Äôaugmentent.


## Synth√®se statistique du mod√®le Cox
```{r survival_semi_parameters_2}
# Cr√©ation du dataframe synth√©tique
df_significatives <- data.frame(
  Variable = c(
    "Religious Compatibility (Not Religious)",
    "Communication Score",
    "Financial Stress Level",
    "Mental Health Issues",
    "Infidelity Occurred",
    "Domestic Violence History",
    "Trust Score"
  ),
  HR = c(0.849, 0.953, 1.028, 1.174, 1.270, 1.443, 0.949),
  Pourcentage_Risque = c(
    "-15%", "-4.7%", "+2.8%", "+17.4%", "+27%", "+44.3%", "-5.1%"
  ),
  Interpretation = c(
    "Non religieuse ‚Üí r√©duction du risque de divorce",
    "Meilleure communication ‚Üí r√©duction du risque",
    "Stress financier ‚Üë ‚Üí risque de divorce ‚Üë",
    "Probl√®mes de sant√© mentale ‚Üë ‚Üí risque ‚Üë",
    "Infid√©lit√© ‚Üí risque de divorce ‚Üë",
    "Historique de violence ‚Üí risque ‚Üë",
    "Confiance ‚Üë ‚Üí r√©duction du risque de divorce"
  )
)

# Coloration dynamique de la colonne Pourcentage_Risque
df_significatives$Pourcentage_Risque <- sapply(df_significatives$Pourcentage_Risque, function(x) {
  value <- as.numeric(gsub("[+%]", "", x))  # extraire valeur num√©rique
  color <- ifelse(value > 0, "red", "green")
  cell_spec(x, color = color, bold = TRUE)
})

# Cr√©ation du tableau
kable(df_significatives, "html", escape = FALSE,
      caption = "üìä Covariables significatives du mod√®le de Cox") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = FALSE) %>%
  column_spec(1, bold = TRUE, color = "black", background = c("#D6EAF8", "#F9E79F", "#FDEDEC", "#D6EAF8", "#F9E79F", "#FDEDEC", "#D6EAF8")) %>%
  column_spec(2, width = "3cm") %>%
  column_spec(3, width = "3cm") %>%
  column_spec(4, width = "8cm") %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2C3E50")
```

# Conclusion

√Ä travers notre analyse de survie, nous avons pu observer diverses applications des fonctions de survie dans l‚Äô√©tude du divorce. La comparaison entre les donn√©es censur√©es et non censur√©es met en √©vidence des diff√©rences notables dans l‚Äôestimation de la survie. Certaines covariables semblent particuli√®rement influentes, comme les probl√®mes de sant√© mentale, qui montrent un impact significatif sur la dur√©e de vie d‚Äôun mariage. En revanche, le niveau d‚Äô√©ducation ne semble pas produire de diff√©rence significative.

L‚Äôutilisation des donn√©es non censur√©es pose des limites pour les estimateurs de Breslow de la fonction de risque, ce qui sugg√®re de privil√©gier l‚Äôestimateur de Nelson-Aalen pour ces donn√©es. N√©anmoins, les deux m√©thodes donnent des r√©sultats globalement similaires, √† une asymptote pr√®s.

Notre analyse r√©v√®le que certains facteurs influencent fortement le risque de divorce, notamment durant la premi√®re ann√©e de mariage, avec une augmentation notable du risque entre 25 et 30 ans de dur√©e de mariage. Selon les crit√®res AIC et BIC, la loi gamma repr√©sente le meilleur ajustement, avec des param√®tres estim√©s √† $\alpha$ = 1.1217 et $\theta$ = 0.1223. 

Enfin, le mod√®le de Cox met en √©vidence l‚Äôinfluence de variables cl√©s sur la survie d‚Äôun mariage : une bonne communication r√©duit le risque de divorce, tandis que la pr√©sence de violence domestique l‚Äôaugmente consid√©rablement.

# R√©f√©rence

- Saint Pierre, P. (2021). *Introduction √† l'analyse des dur√©es de survie*. Institut de Math√©matiques de Toulouse, Universit√© Paul Sabatier.
